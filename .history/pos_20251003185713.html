<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi Chicken Brothers - POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styles for Print */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        
        .receipt-text {
             font-family: 'monospace';
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">

    <div class="flex flex-col lg:flex-row h-screen">
        <!-- Menu Items Section -->
        <div class="w-full lg:w-3/5 p-4 overflow-y-auto">
            <header class="mb-4 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Delhi Chicken Brothers</h1>
                    <p class="text-gray-500">Select items to start an order</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="open-inventory-btn" title="Inventory Management" class="text-gray-500 hover:text-blue-600 p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </button>
                    <button id="open-menu-management-btn" title="Menu Management" class="text-gray-500 hover:text-blue-600 p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </header>
            <div class="mb-4">
                <input type="text" id="search-input" placeholder="Search for items..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            </div>
            <div id="menu-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Menu items will be dynamically inserted here -->
            </div>
        </div>

        <!-- Order Summary Section -->
        <div class="w-full lg:w-2/5 bg-white p-6 shadow-lg flex flex-col">
            <h2 class="text-2xl font-bold border-b pb-4 mb-4">Current Order</h2>
            <div id="order-items-container" class="flex-grow overflow-y-auto">
                <!-- Selected items will be listed here -->
                <p id="empty-order-message" class="text-gray-500 text-center mt-10">Your order is empty.</p>
            </div>
            <div class="mt-4">
                <div id="note-display-container" class="hidden bg-yellow-100 border border-yellow-300 text-yellow-800 p-2 rounded-md mb-2">
                    <p class="font-semibold text-sm">Note:</p>
                    <p id="order-note-text" class="text-sm"></p>
                </div>
                 <button id="add-note-btn" class="w-full text-sm text-blue-600 hover:text-blue-800 mb-4 rounded-md p-2 bg-blue-50 hover:bg-blue-100 transition-colors">Add Note for Kitchen</button>
            </div>
            
            <!-- Totals -->
            <div class="border-t pt-4 mt-4 space-y-2 text-lg">
                <div class="flex justify-between">
                    <span class="text-gray-600">Subtotal</span>
                    <span id="subtotal" class="font-semibold">₹0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">GST (5% included)</span>
                    <span id="gst" class="font-medium text-gray-500">₹0.00</span>
                </div>
                <div class="flex justify-between font-bold text-2xl text-blue-600">
                    <span>Grand Total</span>
                    <span id="grand-total">₹0.00</span>
                </div>
            </div>

            <!-- Payment Mode -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Mode of Payment</h3>
                <div class="flex gap-4">
                    <label class="flex items-center p-3 border rounded-lg flex-1 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="payment-mode" value="Cash" class="h-5 w-5 text-blue-600" checked>
                        <span class="ml-3 text-gray-700 font-medium">Cash</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg flex-1 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="payment-mode" value="UPI" class="h-5 w-5 text-blue-600">
                        <span class="ml-3 text-gray-700 font-medium">UPI</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="clear-order-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-300 transition-transform">Clear</button>
                <button id="finalize-order-btn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition-transform disabled:bg-gray-400 disabled:cursor-not-allowed">Finalize Bill</button>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-10">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add a Note</h3>
            <textarea id="note-input" class="w-full border rounded-md p-2 h-28" placeholder="e.g., Make it extra spicy..."></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button id="cancel-note-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg">Cancel</button>
                <button id="save-note-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Save Note</button>
            </div>
        </div>
    </div>
    
    <!-- Print Modal -->
    <div id="print-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-10">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 class="text-2xl font-bold mb-2">Order Finalized!</h3>
            <p class="text-lg font-semibold mb-6 bg-blue-100 text-blue-800 rounded-md py-2" id="final-order-number"></p>
            <p class="mb-6 text-gray-600">What would you like to print?</p>
            <div class="space-y-4">
                <button id="print-receipt-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-blue-700">Print Customer Receipt</button>
                <button id="print-kot-btn" class="w-full bg-gray-700 text-white py-3 rounded-lg text-lg font-semibold hover:bg-gray-800">Print KOT</button>
            </div>
             <button id="close-print-modal-btn" class="mt-8 text-gray-500 hover:text-gray-700">Close</button>
        </div>
    </div>

    <!-- Menu Management Modal -->
    <div id="menu-management-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-20">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">Menu Management</h2>
                <button id="close-menu-management-btn" class="text-gray-500 hover:text-red-600 text-3xl">&times;</button>
            </header>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex justify-end mb-4">
                    <button id="add-new-item-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add New Item</button>
                </div>
                <div id="menu-list-container" class="space-y-4">
                    <!-- Menu items for management will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Item Add/Edit Modal -->
    <div id="item-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 id="item-modal-title" class="text-xl font-semibold mb-4">Add New Item</h3>
            <form id="item-edit-form">
                <input type="hidden" id="original-item-name">
                <input type="hidden" id="original-item-category">
                <div class="mb-4">
                    <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                    <input type="text" id="item-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                </div>
                <div class="mb-4">
                    <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="item-category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required list="category-list">
                    <datalist id="category-list"></datalist>
                </div>
                <div id="price-variants-container" class="space-y-2 mb-4">
                    <h4 class="text-md font-medium text-gray-800">Price Variants</h4>
                    <!-- Dynamic price variants will be injected here -->
                </div>
                <button type="button" id="add-price-variant-btn" class="text-sm text-blue-600 hover:underline mb-6">+ Add another variant</button>
                
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-item-edit-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg">Cancel</button>
                    <button type="submit" id="save-item-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Inventory Management Modal -->
    <div id="inventory-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-20">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">Inventory Management</h2>
                <button id="close-inventory-btn" class="text-gray-500 hover:text-red-600 text-3xl">&times;</button>
            </header>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="flex justify-end mb-4">
                    <button id="add-new-ingredient-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add New Ingredient</button>
                </div>
                <div id="inventory-list-container" class="space-y-2">
                    <!-- Inventory items will be listed here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ingredient Add/Edit Modal -->
    <div id="ingredient-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 id="ingredient-modal-title" class="text-xl font-semibold mb-4">Add New Ingredient</h3>
            <form id="ingredient-edit-form">
                <input type="hidden" id="original-ingredient-name">
                <div class="mb-4">
                    <label for="ingredient-name" class="block text-sm font-medium text-gray-700">Ingredient Name</label>
                    <input type="text" id="ingredient-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="ingredient-stock" class="block text-sm font-medium text-gray-700">Current Stock</label>
                        <input type="number" id="ingredient-stock" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required min="0" step="any">
                    </div>
                    <div>
                        <label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unit</label>
                        <input type="text" id="ingredient-unit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required placeholder="e.g., g, kg, pcs, l, ml">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-ingredient-edit-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg">Save Ingredient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recipe Builder Modal -->
    <div id="recipe-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[90vh] flex flex-col">
            <header class="p-4 border-b">
                <h2 class="text-2xl font-bold">Recipe Builder</h2>
                <p id="recipe-item-name" class="text-gray-600"></p>
            </header>
            <div id="recipe-variants-container" class="p-6 flex-grow overflow-y-auto space-y-6">
                <!-- Recipe variant sections will be injected here -->
            </div>
            <footer class="p-4 border-t flex justify-end gap-4">
                <button type="button" id="close-recipe-modal-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg">Close</button>
                <button type="button" id="save-recipe-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg">Save Recipe</button>
            </footer>
        </div>
    </div>

    <!-- Hidden Printable Areas -->
    <div id="receipt-print-area" class="print-area receipt-text hidden"></div>
    <div id="kot-print-area" class="print-area receipt-text hidden"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Supabase Client Setup ---
    const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    const KIOSK_INFO = {
        name: "Delhi Chicken Brothers",
        gst: "09ALRPR8561K2Z0",
        phone: "9211022131",
        address: "Shop 6 Aar City Regence Park, UP 201309"
    };

    const defaultMenu = {
        "Tandoori": [
            { name: "Juicy Chicken Kebab", prices: { Half: 79, Full: 149 } },
            { name: "Minced Mutton Kebab", prices: { Half: 99, Full: 179 } },
            { 
                name: "Spicy Chicken Tikka", 
                prices: { Half: 119, Full: 199 },
                recipe: {
                    Half: [{ ingredient: 'Chicken', quantity: 150 }, { ingredient: 'Tandoori Masala', quantity: 10 }],
                    Full: [{ ingredient: 'Chicken', quantity: 300 }, { ingredient: 'Tandoori Masala', quantity: 20 }]
                }
            },
            { name: "Spicy Roasted Tangdi", prices: { Half: 89, Full: 159 } },
            { name: "Chicken Barbeque", prices: { Half: 129, Full: 229 } },
            { name: "Afghani Slurpy Tikka", prices: { Half: 139, Full: 239 } },
            { name: "Spicy Malai Chicken Tikka", prices: { Half: 139, Full: 229 } },
        ],
        "Fried": [
            { name: "Chicken Lollypop Spicy", prices: { Half: 169, Full: 319 } },
            { name: "Deep Fried Chicken", prices: { Half: 119, Full: 199 } },
            { name: "Fried Crispy Tangdi", prices: { Half: 69, Full: 129 } },
            { name: "Crispy Spicy Fried Chicken", prices: { Half: 79, Full: 139 } },
            { name: "Spicy Crispy Fingers", prices: { Half: 119, Full: 199 } },
        ],
        "Rolls": [
            { name: "Spicy Chicken Tikka Roll", prices: { Half: 129, Full: 219 } },
            { name: "Juicy Chicken Kebab Roll", prices: { Half: 89, Full: 169 } },
            { name: "Afghani Slurpy Tikka Roll", prices: { Half: 149, Full: 259 } },
            { name: "Minced Mutton Kebab Roll", prices: { Half: 109, Full: 199 } },
        ],
        "Momos": [
            { name: "Spiciest Chicken Momo", prices: { Half: 70, Full: 130, Fried: 150 } },
            { name: "Spiciest Paneer Momo", prices: { Half: 70, Full: 130, Fried: 150 } },
            { name: "Spiciest Veg Momo", prices: { Half: 60, Full: 100, Fried: 120 } },
        ],
        "Breads": [
            { name: "Roomali", prices: { Regular: 12 }, recipe: { Regular: [{ ingredient: 'Roomali Roti', quantity: 1 }] } }
        ]
    };
    
    const defaultInventory = [
        { name: 'Chicken', stock: 10000, unit: 'g' },
        { name: 'Mutton Mince', stock: 5000, unit: 'g' },
        { name: 'Paneer', stock: 3000, unit: 'g' },
        { name: 'Tandoori Masala', stock: 1000, unit: 'g' },
        { name: 'Roomali Roti', stock: 200, unit: 'pcs' },
        { name: 'Oil', stock: 5000, unit: 'ml' },
    ];

    let menu = {};
    let inventory = [];
    let currentOrder = [];
    let orderNote = '';

    // --- DOM Element Cache ---
    const menuContainer = document.getElementById('menu-container');
    const orderItemsContainer = document.getElementById('order-items-container');
    const emptyOrderMessage = document.getElementById('empty-order-message');
    const subtotalEl = document.getElementById('subtotal');
    const gstEl = document.getElementById('gst');
    const grandTotalEl = document.getElementById('grand-total');
    const finalizeBtn = document.getElementById('finalize-order-btn');
    const clearBtn = document.getElementById('clear-order-btn');
    const addNoteBtn = document.getElementById('add-note-btn');
    const noteModal = document.getElementById('note-modal');
    const noteInput = document.getElementById('note-input');
    const saveNoteBtn = document.getElementById('save-note-btn');
    const cancelNoteBtn = document.getElementById('cancel-note-btn');
    const noteDisplayContainer = document.getElementById('note-display-container');
    const orderNoteText = document.getElementById('order-note-text');
    const printModal = document.getElementById('print-modal');
    const searchInput = document.getElementById('search-input');
    
    // Menu Management Elements
    const openMenuManagementBtn = document.getElementById('open-menu-management-btn');
    const menuManagementModal = document.getElementById('menu-management-modal');
    const closeMenuManagementBtn = document.getElementById('close-menu-management-btn');
    const menuListContainer = document.getElementById('menu-list-container');
    const addNewItemBtn = document.getElementById('add-new-item-btn');
    const itemEditModal = document.getElementById('item-edit-modal');
    const itemEditForm = document.getElementById('item-edit-form');
    const cancelItemEditBtn = document.getElementById('cancel-item-edit-btn');
    const itemModalTitle = document.getElementById('item-modal-title');
    const priceVariantsContainer = document.getElementById('price-variants-container');
    const addPriceVariantBtn = document.getElementById('add-price-variant-btn');

    // Inventory Management Elements
    const openInventoryBtn = document.getElementById('open-inventory-btn');
    const inventoryModal = document.getElementById('inventory-modal');
    const closeInventoryBtn = document.getElementById('close-inventory-btn');
    const inventoryListContainer = document.getElementById('inventory-list-container');
    const addNewIngredientBtn = document.getElementById('add-new-ingredient-btn');
    const ingredientEditModal = document.getElementById('ingredient-edit-modal');
    const ingredientEditForm = document.getElementById('ingredient-edit-form');
    const ingredientModalTitle = document.getElementById('ingredient-modal-title');
    const cancelIngredientEditBtn = document.getElementById('cancel-ingredient-edit-btn');
    
    // Recipe Builder Elements
    const recipeModal = document.getElementById('recipe-modal');
    const closeRecipeModalBtn = document.getElementById('close-recipe-modal-btn');
    const saveRecipeBtn = document.getElementById('save-recipe-btn');
    const recipeItemName = document.getElementById('recipe-item-name');
    const recipeVariantsContainer = document.getElementById('recipe-variants-container');


    // --- Data Persistence ---
    function loadDataFromStorage() {
        const savedMenu = localStorage.getItem('dcbMenu');
        menu = savedMenu ? JSON.parse(savedMenu) : JSON.parse(JSON.stringify(defaultMenu));
        
        const savedInventory = localStorage.getItem('dcbInventory');
        inventory = savedInventory ? JSON.parse(savedInventory) : JSON.parse(JSON.stringify(defaultInventory));

        saveMenuToStorage();
        saveInventoryToStorage();
    }

    function saveMenuToStorage() {
        localStorage.setItem('dcbMenu', JSON.stringify(menu));
    }
    
    function saveInventoryToStorage() {
        localStorage.setItem('dcbInventory', JSON.stringify(inventory));
    }


    // --- Menu Rendering ---
    function formatVariant(variant) {
        const lowerVariant = variant.toLowerCase();
        if (lowerVariant === 'half') {
            return `<span class="text-blue-600 font-semibold">${variant}</span>`;
        }
        if (lowerVariant === 'full') {
            return `<span class="text-green-700 font-semibold">${variant}</span>`;
        }
        return variant;
    }

    function renderMenu(searchTerm = '') {
        menuContainer.innerHTML = '';
        let itemsFound = false;
        const sortedCategories = Object.keys(menu).sort();

        for (const category of sortedCategories) {
            const filteredItems = menu[category].filter(item => 
                !searchTerm || item.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredItems.length === 0) continue;

            itemsFound = true;
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'col-span-full mb-4 mt-2';
            categoryDiv.innerHTML = `<h3 class="text-xl font-bold text-gray-700 border-b-2 border-blue-500 pb-2">${category}</h3>`;
            menuContainer.appendChild(categoryDiv);

            filteredItems.forEach(item => {
                for (const variant in item.prices) {
                    const price = item.prices[variant];
                    const button = document.createElement('button');
                    button.className = 'bg-white p-3 rounded-lg shadow hover:shadow-lg hover:bg-blue-50 transition-all text-left';
                    button.innerHTML = `
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">${formatVariant(variant)}</p>
                        <p class="text-lg font-bold mt-2 text-blue-600">₹${price.toFixed(2)}</p>
                    `;
                    button.addEventListener('click', () => addItemToOrder(item.name, variant, price));
                    menuContainer.appendChild(button);
                }
            });
        }
        if (!itemsFound) {
             menuContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 mt-8">No items match your search.</p>`;
        }
    }

    // --- Order Logic ---
    function addItemToOrder(name, variant, price) {
        const uniqueId = `${name}-${variant}`;
        const existingItem = currentOrder.find(item => item.id === uniqueId);
        if (existingItem) {
            existingItem.qty++;
        } else {
            currentOrder.push({ id: uniqueId, name, variant, price, qty: 1 });
        }
        renderOrder();
    }

    function updateItemQuantity(id, change) {
        const item = currentOrder.find(item => item.id === id);
        if (item) {
            item.qty += change;
            if (item.qty <= 0) {
                currentOrder = currentOrder.filter(item => item.id !== id);
            }
        }
        renderOrder();
    }

    function renderOrder() {
        orderItemsContainer.innerHTML = '';
        if (currentOrder.length === 0) {
            orderItemsContainer.appendChild(emptyOrderMessage);
            emptyOrderMessage.classList.remove('hidden');
        } else {
            emptyOrderMessage.classList.add('hidden');
            currentOrder.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between py-3 border-b';
                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold">${item.name} <span class="text-sm text-gray-500 font-normal">(${item.variant})</span></p>
                        <p class="text-gray-600">₹${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="quantity-change bg-gray-200 rounded-full w-7 h-7 font-bold text-lg" data-id="${item.id}" data-change="-1">-</button>
                        <span class="w-8 text-center font-semibold text-lg">${item.qty}</span>
                        <button class="quantity-change bg-gray-200 rounded-full w-7 h-7 font-bold text-lg" data-id="${item.id}" data-change="1">+</button>
                    </div>
                    <p class="w-20 text-right font-bold text-lg">₹${(item.qty * item.price).toFixed(2)}</p>
                `;
                orderItemsContainer.appendChild(itemDiv);
            });
        }

        document.querySelectorAll('.quantity-change').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.dataset.id;
                const change = parseInt(button.dataset.change);
                updateItemQuantity(id, change);
            });
        });

        calculateTotals();
        updateFinalizeButtonState();
    }
    
    function calculateTotals() {
        const grandTotal = currentOrder.reduce((acc, item) => acc + (item.price * item.qty), 0);
        const gstAmount = grandTotal - (grandTotal / 1.05);

        subtotalEl.textContent = `₹${grandTotal.toFixed(2)}`;
        gstEl.textContent = `₹${gstAmount.toFixed(2)}`;
        grandTotalEl.textContent = `₹${grandTotal.toFixed(2)}`;
    }
    
    function updateFinalizeButtonState() {
        finalizeBtn.disabled = currentOrder.length === 0;
    }
    
    function clearOrder() {
        currentOrder = [];
        orderNote = '';
        noteInput.value = '';
        noteDisplayContainer.classList.add('hidden');
        renderOrder();
    }

    // --- Note Logic ---
    addNoteBtn.addEventListener('click', () => noteModal.classList.remove('hidden'));
    cancelNoteBtn.addEventListener('click', () => noteModal.classList.add('hidden'));
    saveNoteBtn.addEventListener('click', () => {
        orderNote = noteInput.value.trim();
        if(orderNote) {
            orderNoteText.innerText = orderNote;
            noteDisplayContainer.classList.remove('hidden');
        } else {
            noteDisplayContainer.classList.add('hidden');
        }
        noteModal.classList.add('hidden');
    });

    // --- Order Finalization and Printing ---
    clearBtn.addEventListener('click', clearOrder);
    finalizeBtn.addEventListener('click', finalizeOrder);
    searchInput.addEventListener('input', () => renderMenu(searchInput.value));

    function getOrderNumber() {
        const today = new Date().toISOString().split('T')[0];
        let orderData = JSON.parse(localStorage.getItem('orderData'));

        if (!orderData || orderData.date !== today) {
            orderData = { date: today, number: 1 };
        } else {
            orderData.number++;
        }
        localStorage.setItem('orderData', JSON.stringify(orderData));
        return orderData.number;
    }
    
    async function finalizeOrder() {
        try {
            // 1. Deduct from inventory
            currentOrder.forEach(orderItem => {
                const menuItem = Object.values(menu).flat().find(m => m.name === orderItem.name);
                if (menuItem && menuItem.recipe && menuItem.recipe[orderItem.variant]) {
                    const recipeForVariant = menuItem.recipe[orderItem.variant];
                    recipeForVariant.forEach(recipeIngredient => {
                        const inventoryItem = inventory.find(i => i.name === recipeIngredient.ingredient);
                        if (inventoryItem) {
                            inventoryItem.stock -= recipeIngredient.quantity * orderItem.qty;
                        }
                    });
                }
            });
            saveInventoryToStorage();

            // 2. Save order to Supabase database
            const orderNumber = getOrderNumber();
            const paymentMode = document.querySelector('input[name="payment-mode"]:checked').value;
            const grandTotal = currentOrder.reduce((acc, item) => acc + (item.price * item.qty), 0);

            // Insert main order record
            const { data: order, error: orderError } = await supabaseClient
                .from('orders')
                .insert([
                    {
                        order_number: orderNumber,
                        grand_total: grandTotal,
                        payment_mode: paymentMode,
                        note: orderNote,
                        status: 'pending'
                    }
                ])
                .select()
                .single();

            if (orderError) {
                throw new Error(`Failed to save order: ${orderError.message}`);
            }

            // Insert order items
            const orderItems = currentOrder.map(item => ({
                order_id: order.id,
                item_name: item.name,
                variant: item.variant,
                quantity: item.qty,
                price_per_unit: item.price,
                total_price: item.price * item.qty
            }));

            const { error: itemsError } = await supabaseClient
                .from('order_items')
                .insert(orderItems);

            if (itemsError) {
                throw new Error(`Failed to save order items: ${itemsError.message}`);
            }

            // 3. Prepare for printing
            document.getElementById('final-order-number').textContent = `Order #${orderNumber}`;
            prepareReceipt(orderNumber, paymentMode);
            prepareKOT(orderNumber, paymentMode);
            printModal.classList.remove('hidden');

        } catch (error) {
            console.error('Error finalizing order:', error);
            alert(`Error finalizing order: ${error.message}. Please try again.`);
        }
    }

    // --- Printing Logic (Functions unchanged) ---
    function formatDateTime() { /* ... */ }
    function generatePrintHeader(orderNumber, paymentMode) { /* ... */ }
    function prepareReceipt(orderNumber, paymentMode) { /* ... */ }
    function prepareKOT(orderNumber, paymentMode) { /* ... */ }
    // (Re-pasting the full printing functions for completeness as they are large)
    function formatDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString('en-GB'); // DD/MM/YYYY
        const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        return { date, time };
    }

    function generatePrintHeader(orderNumber, paymentMode) {
        const { date, time } = formatDateTime();
        return `
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="font-size: 24px; font-weight: bold; margin: 0;">${KIOSK_INFO.name}</h3>
                <p style="margin: 2px 0;">${KIOSK_INFO.address}</p>
                <p style="margin: 2px 0;">Phone: ${KIOSK_INFO.phone}</p>
                <p style="margin: 2px 0;">GSTIN: ${KIOSK_INFO.gst}</p>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Date: ${date}</span>
                <span>Time: ${time}</span>
            </div>
             <p style="text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 16px;">Payment Mode: ${paymentMode.toUpperCase()}</p>
            <h1 style="text-align: center; font-size: 48px; font-weight: bold; margin: 10px 0; border: 2px solid #000; padding: 5px;">
                ORDER #${orderNumber}
            </h1>
        `;
    }

    function prepareReceipt(orderNumber, paymentMode) {
        const grandTotal = currentOrder.reduce((acc, item) => acc + (item.price * item.qty), 0);
        const gstAmount = grandTotal - (grandTotal / 1.05);
        const taxableValue = grandTotal / 1.05;

        let itemsHtml = `<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="text-align: left; border-bottom: 1px solid #000; padding-bottom: 5px;">Item</th><th style="text-align: right; border-bottom: 1px solid #000; padding-bottom: 5px;">Qty</th><th style="text-align: right; border-bottom: 1px solid #000; padding-bottom: 5px;">Price</th><th style="text-align: right; border-bottom: 1px solid #000; padding-bottom: 5px;">Amount</th></tr></thead><tbody>`;
        currentOrder.forEach(item => {
            itemsHtml += `<tr><td>${item.name} (${item.variant})</td><td style="text-align: right;">${item.qty}</td><td style="text-align: right;">${item.price.toFixed(2)}</td><td style="text-align: right;">${(item.qty * item.price).toFixed(2)}</td></tr>`;
        });
        itemsHtml += '</tbody></table>';

        const receiptHtml = `<div style="width: 300px; margin: 0 auto; padding: 20px;">${generatePrintHeader(orderNumber, paymentMode)}<h4 style="text-align:center; margin-bottom: 10px; font-size: 18px; border-bottom: 1px dashed #000; padding-bottom: 5px;">Customer Receipt</h4>${itemsHtml}<hr style="border: none; border-top: 1px dashed #000; margin: 10px 0;"><div style="margin-top: 20px;"><p style="display: flex; justify-content: space-between;"><span>Taxable Value:</span> <span>₹${taxableValue.toFixed(2)}</span></p><p style="display: flex; justify-content: space-between;"><span>CGST @ 2.5%:</span> <span>₹${(gstAmount / 2).toFixed(2)}</span></p><p style="display: flex; justify-content: space-between;"><span>SGST @ 2.5%:</span> <span>₹${(gstAmount / 2).toFixed(2)}</span></p><hr style="border: none; border-top: 1px solid #000; margin: 10px 0;"><p style="display: flex; justify-content: space-between; font-weight: bold; font-size: 22px;"><span>GRAND TOTAL:</span> <span>₹${grandTotal.toFixed(2)}</span></p></div><p style="text-align: center; margin-top: 20px;">Thank you for your visit!</p></div>`;
        document.getElementById('receipt-print-area').innerHTML = receiptHtml;
    }
    
    function prepareKOT(orderNumber, paymentMode) {
        let itemsHtml = '<div style="margin-top: 20px; font-size: 20px;">';
        currentOrder.forEach(item => {
            itemsHtml += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #000;"><span style="font-weight: bold; font-size: 24px;">${item.qty} x</span><span style="flex-grow: 1; margin-left: 15px;">${item.name} (${item.variant})</span></div>`;
        });
        itemsHtml += '</div>';

        const noteHtml = orderNote ? `<div style="margin-top: 20px; border: 2px solid #000; padding: 10px; font-weight: bold; font-size: 18px;">NOTE: ${orderNote}</div>` : '';
        const kotHtml = `<div style="width: 300px; margin: 0 auto; padding: 20px;">${generatePrintHeader(orderNumber, paymentMode)}<h4 style="text-align:center; font-size: 22px; margin-bottom: 15px;">Kitchen Order Ticket (KOT)</h4>${itemsHtml}${noteHtml}</div>`;
        document.getElementById('kot-print-area').innerHTML = kotHtml;
    }
    
    document.getElementById('print-receipt-btn').addEventListener('click', () => {
        const receiptArea = document.getElementById('receipt-print-area');
        receiptArea.classList.remove('hidden');
        window.print();
        receiptArea.classList.add('hidden');
    });
    
    document.getElementById('print-kot-btn').addEventListener('click', () => {
        const kotArea = document.getElementById('kot-print-area');
        kotArea.classList.remove('hidden');
        window.print();
        kotArea.classList.add('hidden');
    });
    
    document.getElementById('close-print-modal-btn').addEventListener('click', () => {
        printModal.classList.add('hidden');
        clearOrder(); // Clear order after printing is done
    });


    // --- Menu Management ---
    function renderMenuManagementList() {
        menuListContainer.innerHTML = '';
        const categoryList = document.getElementById('category-list');
        categoryList.innerHTML = '';
        const categories = Object.keys(menu).sort();

        categories.forEach(category => {
            const categoryHeader = document.createElement('h3');
            categoryHeader.className = 'text-lg font-semibold text-gray-600 bg-gray-100 p-2 rounded-md';
            categoryHeader.textContent = category;
            menuListContainer.appendChild(categoryHeader);

            const catOption = document.createElement('option');
            catOption.value = category;
            categoryList.appendChild(catOption);

            menu[category].forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center p-3 border rounded-md';
                
                let pricesText = Object.entries(item.prices).map(([variant, price]) => `${variant}: ₹${price}`).join(', ');

                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-500">${pricesText}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="recipe-item-btn text-purple-600 hover:text-purple-800 p-2" data-category="${category}" data-name="${item.name}">Recipe</button>
                        <button class="edit-item-btn text-blue-600 hover:text-blue-800 p-2" data-category="${category}" data-name="${item.name}">Edit</button>
                        <button class="delete-item-btn text-red-600 hover:text-red-800 p-2" data-category="${category}" data-name="${item.name}">Delete</button>
                    </div>
                `;
                menuListContainer.appendChild(itemDiv);
            });
        });

        document.querySelectorAll('.recipe-item-btn').forEach(btn => btn.addEventListener('click', handleRecipeItemClick));
        document.querySelectorAll('.edit-item-btn').forEach(btn => btn.addEventListener('click', handleEditItemClick));
        document.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', handleDeleteItemClick));
    }
    function handleEditItemClick(e) { /* ... */ }
    function handleDeleteItemClick(e) { /* ... */ }
    function openItemEditModal(item, category) { /* ... */ }
    function addPriceVariantInput(variant, price) { /* ... */ }
    // (Re-pasting the full menu management functions)
    function handleEditItemClick(e) {
        const category = e.currentTarget.dataset.category;
        const name = e.currentTarget.dataset.name;
        const item = menu[category].find(i => i.name === name);
        openItemEditModal(item, category);
    }
    function handleDeleteItemClick(e) {
        const category = e.currentTarget.dataset.category;
        const name = e.currentTarget.dataset.name;
        if (confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
            menu[category] = menu[category].filter(i => i.name !== name);
            if (menu[category].length === 0) {
                delete menu[category];
            }
            saveMenuToStorage();
            renderMenu();
            renderMenuManagementList();
        }
    }
    function openItemEditModal(item = null, category = '') {
        itemEditForm.reset();
        priceVariantsContainer.innerHTML = '';
        if (item) {
            itemModalTitle.textContent = 'Edit Menu Item';
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-category').value = category;
            document.getElementById('original-item-name').value = item.name;
            document.getElementById('original-item-category').value = category;

            for(const variant in item.prices) {
                addPriceVariantInput(variant, item.prices[variant]);
            }
        } else {
            itemModalTitle.textContent = 'Add New Item';
            document.getElementById('original-item-name').value = '';
            document.getElementById('original-item-category').value = '';
            addPriceVariantInput(); // Add one empty variant field to start
        }
        itemEditModal.classList.remove('hidden');
    }
    function addPriceVariantInput(variant = '', price = '') {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2';
        div.innerHTML = `<input type="text" placeholder="Variant (e.g., Half)" value="${variant}" class="variant-name mt-1 w-full border border-gray-300 rounded-md py-2 px-3" required><input type="number" placeholder="Price" value="${price}" class="variant-price mt-1 w-full border border-gray-300 rounded-md py-2 px-3" required min="0" step="0.01"><button type="button" class="remove-variant-btn text-red-500 p-2 text-2xl">&times;</button>`;
        priceVariantsContainer.appendChild(div);
        div.querySelector('.remove-variant-btn').addEventListener('click', () => div.remove());
    }
    addPriceVariantBtn.addEventListener('click', () => addPriceVariantInput());
    itemEditForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const itemName = document.getElementById('item-name').value.trim();
        const itemCategory = document.getElementById('item-category').value.trim();
        const originalName = document.getElementById('original-item-name').value;
        const originalCategory = document.getElementById('original-item-category').value;
        if (!itemName || !itemCategory) return;
        const prices = {};
        const variantInputs = priceVariantsContainer.querySelectorAll('.flex');
        let hasVariants = false;
        variantInputs.forEach(div => {
            const variantName = div.querySelector('.variant-name').value.trim();
            const variantPrice = parseFloat(div.querySelector('.variant-price').value);
            if(variantName && !isNaN(variantPrice)) {
                prices[variantName] = variantPrice;
                hasVariants = true;
            }
        });
        if (!hasVariants) { alert("Please add at least one valid price variant."); return; }

        let existingItem = null;
        if (originalName && originalCategory && menu[originalCategory]) {
            existingItem = menu[originalCategory].find(i => i.name === originalName);
            menu[originalCategory] = menu[originalCategory].filter(i => i.name !== originalName);
            if (menu[originalCategory].length === 0) { delete menu[originalCategory]; }
        }
        const newItemData = { name: itemName, prices, recipe: existingItem ? existingItem.recipe : {} };
        if (!menu[itemCategory]) { menu[itemCategory] = []; }
        menu[itemCategory].push(newItemData);
        saveMenuToStorage();
        renderMenu();
        renderMenuManagementList();
        itemEditModal.classList.add('hidden');
    });
    openMenuManagementBtn.addEventListener('click', () => { renderMenuManagementList(); menuManagementModal.classList.remove('hidden'); });
    closeMenuManagementBtn.addEventListener('click', () => menuManagementModal.classList.add('hidden'));
    addNewItemBtn.addEventListener('click', () => openItemEditModal());
    cancelItemEditBtn.addEventListener('click', () => itemEditModal.classList.add('hidden'));


    // --- Inventory Management ---
    function renderInventoryList() {
        inventoryListContainer.innerHTML = '';
        inventory.sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'grid grid-cols-4 gap-4 items-center p-2 border-b';
            itemDiv.innerHTML = `
                <span class="font-semibold col-span-2">${item.name}</span>
                <span>${item.stock} ${item.unit}</span>
                <div class="flex gap-2 justify-end">
                    <button class="edit-ingredient-btn text-blue-600 hover:text-blue-800 p-2" data-name="${item.name}">Edit</button>
                    <button class="delete-ingredient-btn text-red-600 hover:text-red-800 p-2" data-name="${item.name}">Delete</button>
                </div>
            `;
            inventoryListContainer.appendChild(itemDiv);
        });
        document.querySelectorAll('.edit-ingredient-btn').forEach(btn => btn.addEventListener('click', handleEditIngredientClick));
        document.querySelectorAll('.delete-ingredient-btn').forEach(btn => btn.addEventListener('click', handleDeleteIngredientClick));
    }
    function handleEditIngredientClick(e) {
        const name = e.currentTarget.dataset.name;
        const item = inventory.find(i => i.name === name);
        openIngredientEditModal(item);
    }
    function handleDeleteIngredientClick(e) {
        const name = e.currentTarget.dataset.name;
        if (confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
            inventory = inventory.filter(i => i.name !== name);
            // Also remove from all recipes
            Object.values(menu).flat().forEach(menuItem => {
                if(menuItem.recipe) {
                    Object.keys(menuItem.recipe).forEach(variant => {
                        menuItem.recipe[variant] = menuItem.recipe[variant].filter(ing => ing.ingredient !== name);
                    });
                }
            });
            saveInventoryToStorage();
            saveMenuToStorage();
            renderInventoryList();
        }
    }
    function openIngredientEditModal(item = null) {
        ingredientEditForm.reset();
        if (item) {
            ingredientModalTitle.textContent = 'Edit Ingredient';
            document.getElementById('ingredient-name').value = item.name;
            document.getElementById('ingredient-name').readOnly = true;
            document.getElementById('original-ingredient-name').value = item.name;
            document.getElementById('ingredient-stock').value = item.stock;
            document.getElementById('ingredient-unit').value = item.unit;
        } else {
            ingredientModalTitle.textContent = 'Add New Ingredient';
            document.getElementById('ingredient-name').readOnly = false;
            document.getElementById('original-ingredient-name').value = '';
        }
        ingredientEditModal.classList.remove('hidden');
    }
    ingredientEditForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('ingredient-name').value.trim();
        const stock = parseFloat(document.getElementById('ingredient-stock').value);
        const unit = document.getElementById('ingredient-unit').value.trim();
        const originalName = document.getElementById('original-ingredient-name').value;

        if (!name || isNaN(stock) || !unit) return;

        if (originalName) { // Editing existing
            const item = inventory.find(i => i.name === originalName);
            if(item) {
                item.stock = stock;
                item.unit = unit;
            }
        } else { // Adding new
            if (inventory.some(i => i.name.toLowerCase() === name.toLowerCase())) {
                alert('An ingredient with this name already exists.');
                return;
            }
            inventory.push({ name, stock, unit });
        }
        saveInventoryToStorage();
        renderInventoryList();
        ingredientEditModal.classList.add('hidden');
    });
    openInventoryBtn.addEventListener('click', () => { renderInventoryList(); inventoryModal.classList.remove('hidden'); });
    closeInventoryBtn.addEventListener('click', () => inventoryModal.classList.add('hidden'));
    addNewIngredientBtn.addEventListener('click', () => openIngredientEditModal());
    cancelIngredientEditBtn.addEventListener('click', () => ingredientEditModal.classList.add('hidden'));

    // --- Recipe Management ---
    function handleRecipeItemClick(e) {
        const category = e.currentTarget.dataset.category;
        const name = e.currentTarget.dataset.name;
        const item = menu[category].find(i => i.name === name);
        openRecipeBuilderModal(item, category);
    }

    function openRecipeBuilderModal(item, category) {
        recipeItemName.textContent = `${item.name} (${category})`;
        recipeItemName.dataset.category = category;
        recipeItemName.dataset.name = item.name;
        recipeVariantsContainer.innerHTML = '';

        const ingredientOptions = inventory.map(ing => `<option value="${ing.name}"></option>`).join('');

        Object.keys(item.prices).forEach(variant => {
            const variantSection = document.createElement('div');
            variantSection.className = 'border p-4 rounded-lg';
            variantSection.dataset.variant = variant;
            variantSection.innerHTML = `
                <h3 class="font-bold text-lg mb-2">${variant}</h3>
                <div class="ingredient-list space-y-2"></div>
                <button class="add-ingredient-to-recipe-btn text-sm text-blue-600 hover:underline mt-3">+ Add ingredient</button>
            `;
            recipeVariantsContainer.appendChild(variantSection);

            const ingredientListDiv = variantSection.querySelector('.ingredient-list');
            const recipeForVariant = item.recipe ? (item.recipe[variant] || []) : [];
            
            recipeForVariant.forEach(ing => {
                const row = createRecipeIngredientRow(ingredientOptions, ing.ingredient, ing.quantity);
                ingredientListDiv.appendChild(row);
            });

            variantSection.querySelector('.add-ingredient-to-recipe-btn').addEventListener('click', () => {
                const row = createRecipeIngredientRow(ingredientOptions);
                ingredientListDiv.appendChild(row);
            });
        });

        recipeModal.classList.remove('hidden');
    }

    function createRecipeIngredientRow(options, selectedIngredient = '', quantity = '') {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-2 items-center';
        row.innerHTML = `
            <div class="col-span-6">
                <input type="text" list="ingredient-datalist" class="recipe-ingredient-name w-full border-gray-300 rounded-md p-2" placeholder="Select Ingredient" value="${selectedIngredient}">
            </div>
            <div class="col-span-4">
                <input type="number" min="0" step="any" class="recipe-ingredient-quantity w-full border-gray-300 rounded-md p-2" placeholder="Qty" value="${quantity}">
            </div>
            <div class="col-span-2 text-right">
                <button class="remove-recipe-ingredient-btn text-red-500 p-2 text-2xl">&times;</button>
            </div>
            <datalist id="ingredient-datalist">${options}</datalist>
        `;
        row.querySelector('.remove-recipe-ingredient-btn').addEventListener('click', () => row.remove());
        return row;
    }

    saveRecipeBtn.addEventListener('click', () => {
        const category = recipeItemName.dataset.category;
        const name = recipeItemName.dataset.name;
        const menuItem = menu[category].find(i => i.name === name);
        
        if (!menuItem) return;

        const newRecipe = {};
        const variantSections = recipeVariantsContainer.querySelectorAll('[data-variant]');
        
        variantSections.forEach(section => {
            const variant = section.dataset.variant;
            newRecipe[variant] = [];
            const ingredientRows = section.querySelectorAll('.grid.grid-cols-12');
            ingredientRows.forEach(row => {
                const ingredientName = row.querySelector('.recipe-ingredient-name').value;
                const quantity = parseFloat(row.querySelector('.recipe-ingredient-quantity').value);
                const isValidIngredient = inventory.some(invItem => invItem.name === ingredientName);

                if (ingredientName && !isNaN(quantity) && quantity > 0 && isValidIngredient) {
                    newRecipe[variant].push({ ingredient: ingredientName, quantity: quantity });
                }
            });
        });
        
        menuItem.recipe = newRecipe;
        saveMenuToStorage();
        recipeModal.classList.add('hidden');
    });

    closeRecipeModalBtn.addEventListener('click', () => recipeModal.classList.add('hidden'));
    
    // --- Initial calls ---
    loadDataFromStorage();
    renderMenu();
    updateFinalizeButtonState();
});
</script>

</body>
</html>
