<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Report - Delhi Chicken Brothers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Sales Report</h1>
                    <p class="text-gray-600">Delhi Chicken Brothers - Comprehensive Sales Analytics</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='pos.html'" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Back to POS
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Date Range Filters -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <select id="date-range" class="w-48 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div id="custom-date-range" class="hidden">
                    <div class="flex gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                            <input type="date" id="start-date" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                            <input type="date" id="end-date" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <button id="apply-filter" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Apply Filter
                </button>
                
                <button id="export-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    Export Report
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 text-xl font-bold">â‚¹</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Sales</p>
                        <p id="total-sales" class="text-2xl font-bold text-gray-900">â‚¹0.00</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-green-600 text-xl font-bold">ðŸ“¦</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Orders</p>
                        <p id="total-orders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-purple-600 text-xl font-bold">ðŸ’°</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Average Order Value</p>
                        <p id="avg-order-value" class="text-2xl font-bold text-gray-900">â‚¹0.00</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-orange-600 text-xl font-bold">ðŸ“Š</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Items Sold</p>
                        <p id="total-items" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Method Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Method Breakdown</h3>
                <div id="payment-chart-container" class="h-64">
                    <canvas id="payment-chart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Sales Trend</h3>
                <div id="sales-chart-container" class="h-64">
                    <canvas id="sales-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Product Performance -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Performing Products</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity Sold</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Revenue</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Price</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Product data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Detailed Orders Table -->
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Detailed Orders</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Mode</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Order data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                <span class="text-gray-700">Loading sales data...</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Global variables
        let ordersData = [];
        let orderItemsData = [];
        let filteredOrders = [];
        let filteredOrderItems = [];
        
        // Chart instances
        let paymentChart = null;
        let salesChart = null;

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const dateRangeSelect = document.getElementById('date-range');
        const customDateRange = document.getElementById('custom-date-range');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyFilterBtn = document.getElementById('apply-filter');
        const exportBtn = document.getElementById('export-btn');

        // Supabase Client Setup
        const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeDateInputs();
            loadDataFromSupabase();
            setupEventListeners();
        });

        function initializeDateInputs() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            startDateInput.value = today.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
        }

        function setupEventListeners() {
            dateRangeSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDateRange.classList.remove('hidden');
                } else {
                    customDateRange.classList.add('hidden');
                }
            });

            applyFilterBtn.addEventListener('click', applyFilters);
            exportBtn.addEventListener('click', exportReport);
        }

        function showLoading() {
            loadingOverlay.classList.remove('hidden');
            document.body.classList.add('loading');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
            document.body.classList.remove('loading');
        }

        async function loadDataFromSupabase() {
            showLoading();
            
            try {
                // Fetch orders data from Supabase
                const { data: orders, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (ordersError) {
                    throw new Error(`Failed to fetch orders: ${ordersError.message}`);
                }

                // Fetch order items data from Supabase
                const { data: orderItems, error: itemsError } = await supabaseClient
                    .from('order_items')
                    .select('*')
                    .order('order_id', { ascending: true });

                if (itemsError) {
                    throw new Error(`Failed to fetch order items: ${itemsError.message}`);
                }

                // Store the data
                ordersData = orders || [];
                orderItemsData = orderItems || [];

                console.log(`Loaded ${ordersData.length} orders and ${orderItemsData.length} order items from Supabase`);

                // Apply default filter (today)
                applyFilters();
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                alert(`Error loading sales data: ${error.message}. Please check the console for details.`);
            } finally {
                hideLoading();
            }
        }

        function parseCSVData() {
            // Parse orders CSV
            const ordersCSV = `id,grand_total,payment_mode,note,created_at
1,12,Cash,,2025-09-22 17:47:58.533596+00
2,12,Cash,,2025-09-22 17:48:40.02867+00
3,151,UPI,,2025-09-22 17:49:01.417487+00
4,199,Cash,,2025-09-22 17:56:41.360328+00
5,119,Cash,,2025-09-22 18:04:22.665714+00
6,119,Cash,,2025-09-22 18:24:07.780886+00
7,139,Cash,,2025-09-22 18:24:13.111434+00
8,199,Cash,,2025-09-22 18:32:18.525015+00
9,330,Cash,,2025-09-22 18:32:45.420983+00
10,337,UPI,,2025-09-22 18:33:47.429403+00
11,536,UPI,,2025-09-22 18:36:35.612925+00
12,119,Cash,,2025-09-22 19:03:12.599628+00
13,368,Cash,,2025-09-22 19:24:46.087099+00
14,119,Cash,,2025-09-22 19:39:40.538275+00
15,198,Cash,,2025-09-22 19:49:02.817091+00
16,362,UPI,I want more spicy,2025-09-22 19:53:02.045959+00
17,211,UPI,Need more onions,2025-09-22 19:57:54.355091+00
18,258,UPI,Less Spicy,2025-09-22 20:11:07.874422+00
19,12,Cash,,2025-09-22 20:20:41.924287+00
20,342,UPI,,2025-09-23 04:04:28.117423+00
21,119,Cash,,2025-09-23 09:38:07.575285+00
22,198,UPI,Less Spicy,2025-09-23 11:07:40.701179+00
23,342,Cash,Spicy,2025-09-23 11:50:18.562839+00
24,210,UPI,,2025-09-24 04:20:55.016597+00
25,638,UPI,,2025-09-25 03:37:12.743212+00
26,139,Cash,,2025-09-27 13:00:38.116602+00
27,728,Cash,,2025-09-27 14:55:38.635166+00
28,299,Cash,,2025-09-27 14:56:33.351836+00
29,249,Cash,,2025-09-27 15:01:22.057512+00
30,150,UPI,,2025-09-27 15:02:11.465211+00
31,249,UPI,,2025-09-27 15:04:16.152382+00
32,299,Cash,,2025-09-27 15:05:36.096691+00
33,299,UPI,,2025-09-27 15:07:31.597273+00
34,419,UPI,,2025-09-27 15:08:48.532758+00
35,260,UPI,,2025-09-27 15:11:43.318098+00
36,389,UPI,,2025-09-27 15:12:29.196273+00
37,249,UPI,,2025-09-27 15:14:01.378315+00
38,638,UPI,,2025-09-27 15:16:22.323668+00
39,299,UPI,Bade Piece,2025-09-27 15:17:11.584642+00
40,130,Cash,,2025-09-27 15:19:14.792714+00
41,508,UPI,,2025-09-27 15:22:54.167139+00
42,150,Cash,,2025-09-27 15:24:39.700275+00
43,789,UPI,,2025-09-27 15:27:53.466159+00
44,789,UPI,Packing,2025-09-27 15:28:39.934031+00
45,259,UPI,,2025-09-27 15:29:44.593806+00
46,539,Cash,,2025-09-27 15:33:10.798609+00
47,219,UPI,,2025-09-27 15:39:17.827984+00
48,369,UPI,,2025-09-27 15:40:16.831928+00
49,150,UPI,,2025-09-27 15:43:08.896867+00
50,259,UPI,,2025-09-27 15:44:02.262998+00
51,259,UPI,,2025-09-27 15:45:15.114032+00
52,259,UPI,,2025-09-27 15:46:38.364748+00
53,219,UPI,,2025-09-27 15:47:29.644699+00
54,389,UPI,,2025-09-27 15:48:53.953342+00
55,249,UPI,,2025-09-27 15:49:23.908475+00
56,419,UPI,,2025-09-27 15:49:44.68062+00
57,130,UPI,,2025-09-27 15:50:51.528197+00
58,518,Cash,,2025-09-27 15:52:15.236193+00
59,259,UPI,Packing,2025-09-27 15:53:20.316566+00
60,339,UPI,,2025-09-27 15:53:55.302581+00
61,100,UPI,,2025-09-27 15:54:45.363217+00
62,100,UPI,,2025-09-27 15:55:02.823712+00
63,1137,UPI,,2025-09-27 15:55:59.473737+00
64,259,UPI,,2025-09-27 15:57:24.086454+00
65,259,UPI,,2025-09-27 15:59:47.189471+00
66,369,UPI,Packing,2025-09-27 16:00:45.350912+00
67,199,UPI,,2025-09-27 16:03:15.121196+00
68,150,UPI,,2025-09-27 16:07:34.809612+00
69,299,UPI,,2025-09-27 16:09:52.747518+00
70,319,UPI,,2025-09-27 16:10:38.01771+00
71,319,Cash,,2025-09-27 16:11:07.944172+00
72,150,Cash,,2025-09-27 16:12:06.321758+00
73,130,UPI,,2025-09-27 16:12:52.926177+00
74,150,UPI,,2025-09-27 16:13:21.256507+00
75,150,UPI,,2025-09-27 16:14:00.337967+00
76,150,UPI,,2025-09-27 16:17:29.202551+00
77,219,Cash,,2025-09-27 16:20:09.002718+00
78,259,UPI,,2025-09-27 16:20:52.304244+00
79,159,Cash,,2025-09-27 16:23:36.72503+00
80,130,Cash,,2025-09-27 16:24:13.214331+00
81,150,Cash,,2025-09-27 16:25:01.89639+00
82,159,UPI,,2025-09-27 16:26:32.940894+00
83,259,UPI,,2025-09-27 16:30:10.914152+00
84,300,UPI,,2025-09-27 16:31:11.613612+00
85,419,Cash,,2025-09-27 16:32:48.772808+00
86,249,UPI,,2025-09-27 16:33:46.847319+00
87,249,UPI,Packing,2025-09-27 16:33:55.701028+00
88,509,UPI,Packing,2025-09-27 16:35:15.923001+00
89,150,UPI,,2025-09-27 16:35:37.868301+00
90,638,Cash,,2025-09-27 16:36:30.609923+00
91,928,UPI,Packing,2025-09-27 16:37:40.18663+00
92,708,UPI,,2025-09-27 16:39:21.464191+00
93,468,UPI,,2025-09-27 16:41:49.636351+00
94,419,UPI,,2025-09-27 16:42:43.163996+00
95,219,UPI,,2025-09-27 16:46:06.06891+00
96,299,UPI,Packing,2025-09-27 16:47:55.655994+00
97,219,UPI,,2025-09-27 16:48:46.61029+00
98,150,Cash,,2025-09-27 16:50:18.306922+00
99,300,Cash,,2025-09-27 16:50:51.206888+00
100,468,Cash,,2025-09-27 16:52:34.610573+00`;

            // Parse order items CSV (sample data for demonstration)
            const orderItemsCSV = `id,order_id,item_name,variant,quantity,price_per_unit
00443910-35de-4271-8ae5-db5f8109749d,555,Juicy Chicken Kebab,Full,1,229
00495b42-ed27-470e-aa4e-09c866e21de6,290,Roomali,Regular,2,20
005963c7-507e-495d-a676-c6810e3a0384,140,Juicy Chicken Kebab,Half,1,109
00691564-bebd-4353-81a3-aeb9e85bd1e5,131,Spicy Chicken Tikka,Full,1,259
0087721c-72b1-4d9d-937d-6fc4feb3178e,429,Roomali,Regular,2,20
0089599f-0046-418f-9e79-b438803b4fdc,120,Spicy Chicken Tikka,Full,1,259
00f06d3e-968c-4de9-803d-e8bc3deb3b3d,11,Crispy Spicy Fried Chicken,Half,1,79
00f38a46-b17e-4377-9b64-8549f40d185c,639,Chicken Biryani,Half,1,249
00f72047-1702-4fe5-a686-a0d2e292c9f1,609,Chicken Biryani,Half,1,249
014c4579-d318-406e-a071-15213b06e647,273,Roomali,Regular,4,20`;

            // Parse CSV data
            ordersData = parseCSV(ordersCSV);
            orderItemsData = parseCSV(orderItemsCSV);

            // Convert types
            ordersData.forEach(order => {
                order.grand_total = parseFloat(order.grand_total) || 0;
            });

            orderItemsData.forEach(item => {
                item.quantity = parseInt(item.quantity) || 0;
                item.price_per_unit = parseFloat(item.price_per_unit) || 0;
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const obj = {};
                const currentline = lines[i].split(',');
                
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentline[j];
                }
                result.push(obj);
            }
            return result;
        }

        function applyFilters() {
            showLoading();
            
            setTimeout(() => {
                try {
                    const dateRange = dateRangeSelect.value;
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    
                    // Filter data based on date range
                    filteredOrders = filterOrdersByDate(ordersData, dateRange, startDate, endDate);
                    filteredOrderItems = orderItemsData.filter(item => 
                        filteredOrders.some(order => order.id === item.order_id)
                    );
                    
                    updateDashboard();
                    updateCharts();
                    updateProductTable();
                    updateOrdersTable();
                } catch (error) {
                    console.error('Error applying filters:', error);
                } finally {
                    hideLoading();
                }
            }, 500);
        }

        function filterOrdersByDate(orders, dateRange, startDate, endDate) {
            const now = new Date();
            let filtered = [...orders];
            
            switch (dateRange) {
                case 'today':
                    filtered = orders.filter(order => {
                        const orderDate = new Date(order.created_at);
                        return orderDate.toDateString() === now.toDateString();
                    });
                    break;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    filtered = orders.filter(order => {
                        const orderDate = new Date(order.created_at);
                        return orderDate.toDateString() === yesterday.toDateString();
                    });
                    break;
                case 'week':
                    const weekAgo = new Date(now);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    filtered = orders.filter(order => {
                        const orderDate = new Date(order.created_at);
                        return orderDate >= weekAgo && orderDate <= now;
                    });
                    break;
                case 'month':
                    const monthAgo = new Date(now);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    filtered = orders.filter(order => {
                        const orderDate = new Date(order.created_at);
                        return orderDate >= monthAgo && orderDate <= now;
                    });
                    break;
                case 'custom':
                    if (startDate && endDate) {
                        filtered = orders.filter(order => {
                            const orderDate = new Date(order.created_at.split(' ')[0]);
                            const start = new Date(startDate);
                            const end = new Date(endDate);
                            return orderDate >= start && orderDate <= end;
                        });
                    }
                    break;
                default:
                    // Show all data
                    break;
            }
            
            return filtered;
        }

        function updateDashboard() {
            const totalSales = filteredOrders.reduce((sum, order) => sum + order.grand_total, 0);
            const totalOrders = filteredOrders.length;
            const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;
            const totalItems = filteredOrderItems.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('total-sales').textContent = `â‚¹${totalSales.toLocaleString('en-IN')}`;
            document.getElementById('total-orders').textContent = totalOrders.toLocaleString('en-IN');
            document.getElementById('avg-order-value').textContent = `â‚¹${avgOrderValue.toFixed(2)}`;
            document.getElementById('total-items').textContent = totalItems.toLocaleString('en-IN');
        }

        function updateCharts() {
            updatePaymentChart();
            updateSalesChart();
        }

        function updatePaymentChart() {
            const ctx = document.getElementById('payment-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (paymentChart) {
                paymentChart.destroy();
            }
            
            const paymentMethods = {};
            filteredOrders.forEach(order => {
                paymentMethods[order.payment_mode] = (paymentMethods[order.payment_mode] || 0) + 1;
            });
            
            const labels = Object.keys(paymentMethods);
            const data = Object.values(paymentMethods);
            
            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3B82F6',
                            '#10B981',
                            '#8B5CF6',
                            '#F59E0B',
                            '#EF4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Payment Method Distribution'
                        }
                    }
                }
            });
        }

        function updateSalesChart() {
            const ctx = document.getElementById('sales-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (salesChart) {
                salesChart.destroy();
            }
            
            // Group sales by date
            const salesByDate = {};
            filteredOrders.forEach(order => {
                const date = order.created_at.split(' ')[0];
                salesByDate[date] = (salesByDate[date] || 0) + order.grand_total;
            });
            
            const labels = Object.keys(salesByDate).sort();
            const data = labels.map(date => salesByDate[date]);
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Sales (â‚¹)',
                        data: data,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Sales Trend'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚¹' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProductTable() {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '';
            
            // Group items by product and variant
            const productStats = {};
            filteredOrderItems.forEach(item => {
                const key = `${item.item_name}|${item.variant}`;
                if (!productStats[key]) {
                    productStats[key] = {
                        item_name: item.item_name,
                        variant: item.variant,
                        quantity: 0,
                        revenue: 0,
                        count: 0
                    };
                }
                productStats[key].quantity += item.quantity;
                productStats[key].revenue += item.quantity * item.price_per_unit;
                productStats[key].count += 1;
            });
            
            // Convert to array and sort by revenue
            const topProducts = Object.values(productStats)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 10);
            
            topProducts.forEach(product => {
                const avgPrice = product.revenue / product.quantity;
                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.item_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.variant}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">â‚¹${product.revenue.toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">â‚¹${avgPrice.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';
            
            filteredOrders.slice(0, 20).forEach(order => {
                const orderItems = filteredOrderItems.filter(item => item.order_id === order.id);
                const itemsText = orderItems.map(item => 
                    `${item.quantity}x ${item.item_name} (${item.variant})`
                ).join(', ');
                
                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateTime(order.created_at)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${itemsText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.payment_mode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">â‚¹${order.grand_total}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${order.note || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleDateString('en-IN') + ' ' + date.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function exportReport() {
            // Simple export functionality - in a real app, this would generate a proper CSV/PDF
            alert('Export functionality would generate a comprehensive sales report in CSV/PDF format. This would include all filtered data, charts, and product performance metrics.');
        }
    </script>
</body>
</html>
