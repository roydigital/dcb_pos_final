<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi Chicken Brothers - Authentic Taste from Delhi</title>
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1137576755203760');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1137576755203760&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Poppins', 'Roboto', sans-serif;
            background-color: #FDF3E7; /* Cream background from logo */
        }
        /* Custom styles inspired by the logo */
        :root {
            --brand-red: #D12727;
            --brand-dark: #2C2C2C;
            --brand-cream: #FDF3E7;
            --brand-light-cream: #FFFBF5;
        }
        .bg-brand-red { background-color: var(--brand-red); }
        .text-brand-red { color: var(--brand-red); }
        .border-brand-red { border-color: var(--brand-red); }
        .bg-brand-dark { background-color: var(--brand-dark); }
        .text-brand-dark { color: var(--brand-dark); }
        .bg-brand-cream { background-color: var(--brand-cream); }
        .text-brand-cream { color: var(--brand-cream); }
        .bg-brand-light-cream { background-color: var(--brand-light-cream); }

        /* Custom scrollbar for a more polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--brand-cream);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--brand-red);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a81f1f;
        }
        .menu-card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .nav-item {
            position: relative;
            transition: color 0.3s;
        }
        .nav-item::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--brand-red);
            transition: width 0.3s;
        }
        .nav-item:hover::after {
            width: 100%;
        }
        /* Style for active category button */
        .category-btn-active {
            background-color: var(--brand-red);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(209, 39, 39, 0.3);
        }

        /* Cart animation */
        .cart-item-enter {
            opacity: 0;
            transform: translateX(100%);
        }
        .cart-item-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: opacity 300ms, transform 300ms;
        }
    </style>
</head>
<body class="text-brand-dark">

    <!-- App Container -->
    <div id="app" class="relative">
        
        <!-- Header -->
        <header class="bg-brand-cream sticky top-0 z-40 shadow-md" style="background-color: #FDF3E7 !important;">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <a href="#" class="flex items-center gap-2">
                    <img src="https://dcbchicken.com/images/logo.png" alt="Delhi Chicken Brothers Logo" class="h-12 w-12 md:h-14 md:w-14">
                    <span class="text-xl md:text-2xl font-bold text-brand-dark hidden sm:block">Delhi Chicken Brothers</span>
                </a>
                <nav class="hidden md:flex items-center gap-6 font-medium">
                    <a href="#menu" class="nav-item">Menu</a>
                    <a href="#about" class="nav-item">About Us</a>
                    <a href="#contact" class="nav-item">Contact</a>
                </nav>
                    <div class="flex items-center gap-4">
                        <div id="auth-container"></div>
                        <button id="cart-button" class="relative p-2 rounded-full hover:bg-red-100 transition-colors">
                            <i data-lucide="shopping-cart" class="h-6 w-6"></i>
                            <span id="cart-count" class="absolute -top-1 -right-1 bg-brand-red text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
                        </button>
                        <button id="mobile-menu-button" class="md:hidden p-2 rounded-full hover:bg-red-100 transition-colors">
                            <i data-lucide="menu" class="h-6 w-6"></i>
                        </button>
                    </div>
            </div>
        </header>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-brand-light-cream shadow-lg z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="p-4 flex justify-end">
                <button id="close-mobile-menu" class="p-2 rounded-full hover:bg-red-100">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <nav class="flex flex-col items-center gap-6 mt-8 font-medium text-lg">
                <a href="#menu" class="mobile-nav-link">Menu</a>
                <a href="#about" class="mobile-nav-link">About Us</a>
                <a href="#contact" class="mobile-nav-link">Contact</a>
            </nav>
        </div>
        <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

        <!-- Main Content -->
        <main>
            <!-- Hero Section -->
            <section class="relative h-[60vh] md:h-[70vh] bg-cover bg-center" style="background-image: url('https://dcbchicken.com/images/Website%20Hero%20Image.jpg');">
                <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                <div class="relative z-10 container mx-auto px-4 h-full flex flex-col justify-center items-start text-white">
                    <h1 class="text-4xl md:text-6xl font-bold leading-tight mb-4 text-shadow">An Authentic Taste<br>Legacy from Delhi.</h1>
                    <p class="text-lg md:text-xl mb-8 max-w-lg text-shadow-sm">Freshly prepared, rich in flavor. Straight from our kitchen to your plate.</p>
                    <a href="#menu" class="bg-brand-red text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all duration-300 shadow-lg">
                        Explore Menu
                    </a>
                </div>
            </section>

            <!-- Menu Section -->
            <section id="menu" class="py-16 md:py-24">
                <div class="container mx-auto px-4">
                    <h2 class="text-3xl md:text-4xl font-bold text-center mb-4">Our Menu</h2>
                    <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">Discover a variety of dishes, each crafted with authentic spices and traditional recipes from the heart of Delhi.</p>
                    
                    <!-- Category Filters -->
                    <div id="category-filters" class="flex flex-wrap justify-center gap-2 md:gap-4 mb-12">
                         <!-- Categories will be injected here by JS -->
                    </div>

                    <!-- Menu Grid -->
                    <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8">
                        <!-- Menu items will be injected here by JS -->
                    </div>
                </div>
            </section>

            <!-- About Us Section -->
            <section id="about" class="bg-brand-light-cream py-16 md:py-24">
                <div class="container mx-auto px-4">
                    <div class="flex flex-col md:flex-row items-center gap-12">
                        <div class="w-full md:w-1/2">
                        <img src="https://dcbchicken.com/images/logo.png" alt="DCB Chefs" class="rounded-lg shadow-xl mx-auto max-w-xs md:max-w-sm">
                        </div>
                        <div class="w-full md:w-1/2 text-center md:text-left">
                            <h2 class="text-3xl md:text-4xl font-bold mb-4">The Story of DCB</h2>
                            <p class="text-gray-600 leading-relaxed mb-4">
                                Delhi Chicken Brothers (DCB) was born from a passion for authentic Delhi-style cuisine. Our founders, two brothers with roots in Old Delhi's bustling food streets, wanted to bring the true flavors of their childhood to the world. 
                            </p>
                            <p class="text-gray-600 leading-relaxed">
                                We use generations-old recipes, fresh ingredients, and a lot of love to create dishes that are both comforting and unforgettable. It's not just food; it's a legacy.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Footer -->
        <footer id="contact" class="bg-brand-dark text-brand-cream border-t border-gray-700">
            <div class="container mx-auto px-4 py-12">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <!-- Brand Info -->
                    <div class="col-span-1 md:col-span-1">
                        <a href="#" class="flex items-center gap-3 mb-4">
                            <img src="https://dcbchicken.com/images/logo.png" alt="Delhi Chicken Brothers Logo" class="h-12 w-12">
                            <span class="text-xl font-bold">Delhi Chicken Brothers</span>
                        </a>
                        <p class="text-gray-400 text-sm leading-relaxed">
                            An authentic taste legacy from Delhi. Freshly prepared, rich in flavor, straight from our kitchen to your plate.
                        </p>
                    </div>

                    <!-- Quick Links -->
                    <div>
                        <h4 class="font-bold text-lg mb-4 tracking-wider">Quick Links</h4>
                        <ul class="space-y-2">
                            <li><a href="#menu" class="text-gray-400 hover:text-brand-red transition-colors">Menu</a></li>
                            <li><a href="#about" class="text-gray-400 hover:text-brand-red transition-colors">About Us</a></li>
                            <li><a href="contact-us.html" class="text-gray-400 hover:text-brand-red transition-colors">Contact</a></li>
                            <li><a href="order-history.html" class="text-gray-400 hover:text-brand-red transition-colors">My Orders</a></li>
                        </ul>
                    </div>

                    <!-- Legal -->
                    <div>
                        <h4 class="font-bold text-lg mb-4 tracking-wider">Legal</h4>
                        <ul class="space-y-2">
                            <li><a href="terms-and-conditions.html" class="text-gray-400 hover:text-brand-red transition-colors">Terms & Conditions</a></li>
                            <li><a href="privacy-policy.html" class="text-gray-400 hover:text-brand-red transition-colors">Privacy Policy</a></li>
                            <li><a href="refund-cancellation-policy.html" class="text-gray-400 hover:text-brand-red transition-colors">Refund & Cancellation</a></li>
                            <li><a href="delivery-policy.html" class="text-gray-400 hover:text-brand-red transition-colors">Delivery Policy</a></li>
                        </ul>
                    </div>

                    <!-- Contact Us -->
                    <div>
                        <h4 class="font-bold text-lg mb-4 tracking-wider">Contact Us</h4>
                        <p class="text-gray-400 mb-2 text-sm">AAR City Regency Park Market</p>
                        <p class="text-gray-400 text-sm">
                            Call for orders: <a href="tel:9211022131" class="text-brand-red font-semibold hover:underline">9211022131</a>
                        </p>
                         <div class="flex gap-4 mt-6">
                            <a href="https://link.zomato.com/xqzv/rshare?id=11881452130563f13" target="_blank" rel="noopener noreferrer" class="hover:opacity-80 transition-opacity" aria-label="Zomato">
                                <img src="https://dcbchicken.com/images/zomato.png" class="h-8" alt="Zomato">
                            </a>
                            <a href="https://www.swiggy.com/direct/brand/691868?source=swiggy-direct&subSource=google" target="_blank" rel="noopener noreferrer" class="hover:opacity-80 transition-opacity" aria-label="Swiggy">
                                <img src="https://dcbchicken.com/images/swiggy.png" class="h-8" alt="Swiggy">
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Bottom Bar -->
                <div class="border-t border-gray-700 mt-8 pt-6 text-center">
                    <p class="text-sm text-gray-400">&copy; 2024 Delhi Chicken Brothers. All Rights Reserved.</p>
                </div>
            </div>
        </footer>

        <!-- Shopping Cart Sidebar -->
        <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-brand-light-cream shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 class="text-xl font-bold">Your Order</h3>
                <button id="close-cart" class="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="cart-items" class="flex-grow p-4 overflow-y-auto">
                <!-- Cart items will be injected here -->
                 <div id="empty-cart-message" class="text-center text-gray-500 mt-8">
                    <i data-lucide="shopping-basket" class="h-16 w-16 mx-auto text-gray-300 mb-4"></i>
                    Your cart is empty. <br> Add some delicious food to get started!
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 bg-white">
                <div class="flex justify-between items-center mb-2 font-medium">
                    <span>Subtotal</span>
                    <span id="cart-subtotal">₹0.00</span>
                </div>
                <div id="cart-discount-row" class="flex justify-between items-center mb-2 font-medium text-green-600 hidden">
                    <span>Discount</span>
                    <span id="cart-discount-amount">-₹0.00</span>
                </div>
                <div class="flex justify-between items-center mb-4 text-gray-500 text-sm">
                    <span>Taxes & Charges</span>
                    <span id="cart-taxes">₹0.00</span>
                </div>
                <div class="flex justify-between items-center mb-6 font-bold text-lg">
                    <span>Total</span>
                    <span id="cart-total">₹0.00</span>
                </div>

                <!-- Coupon Application -->
                <div class="mb-4">
                    <h4 class="font-bold mb-2">Apply Coupon</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="customer-coupon-code" placeholder="Enter coupon code" class="flex-1 p-2 border border-gray-300 rounded-md text-sm">
                        <button id="apply-customer-coupon" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm hover:bg-green-700">Apply</button>
                    </div>
                    <div id="customer-coupon-message" class="text-sm hidden"></div>
                    <div id="applied-customer-coupon" class="hidden bg-green-50 border border-green-200 rounded-md p-3 mt-2">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-green-800" id="applied-customer-coupon-name"></p>
                                <p class="text-sm text-green-600" id="applied-customer-coupon-discount"></p>
                            </div>
                            <button id="remove-customer-coupon" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                        </div>
                    </div>
                </div>

                <!-- Checkout Options -->
                <div id="checkout-options" class="mb-4">
                    <div class="mb-4">
                        <h4 class="font-bold mb-2">Order Type</h4>
                        <div class="flex justify-around">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="orderType" value="Dine-in" class="form-radio text-brand-red" checked>
                                <span>Dine-in</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="orderType" value="Takeaway" class="form-radio text-brand-red">
                                <span>Takeaway</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="orderType" value="Delivery" class="form-radio text-brand-red">
                                <span>Delivery</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2">Payment Method</h4>
                        <div class="flex justify-around">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="UPI" class="form-radio text-brand-red" checked>
                                <span>UPI</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="paymentMethod" value="Cash" class="form-radio text-brand-red">
                                <span>Cash</span>
                            </label>
                        </div>
                    </div>
                </div>

                <button id="checkout-button" class="w-full bg-brand-red text-white font-bold py-3 rounded-lg hover:bg-opacity-90 transition-all duration-300 flex items-center justify-center gap-2">
                    <i data-lucide="lock" class="h-5 w-5"></i>
                    Proceed to Checkout
                </button>
            </div>
        </div>
        <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
        
        <!-- Order Status Bar -->
        <div id="order-status-bar" class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 transform translate-y-full transition-transform duration-300 z-50 hidden">
          <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="flex-shrink-0">
                  <div class="w-10 h-10 bg-brand-red rounded-full flex items-center justify-center text-white">
                    <i data-lucide="package" class="h-5 w-5"></i>
                  </div>
                </div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800 text-sm">Order #<span id="bar-order-id">---</span></h4>
                  <div class="flex items-center space-x-2 mt-1">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <p class="text-xs text-gray-600">Status: <span id="bar-order-status" class="font-medium">---</span></p>
                    <span id="bar-order-time" class="text-xs text-gray-500">Just now</span>
                  </div>
                </div>
              </div>
              <button id="view-order-details" class="bg-brand-red text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors text-sm font-medium flex items-center space-x-2">
                <i data-lucide="eye" class="h-4 w-4"></i>
                <span>View Details</span>
              </button>
            </div>
          </div>
        </div>
        
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Function to request location permission
        async function requestLocationPermission() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('Geolocation is not supported by this browser.');
                    resolve(false);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Location permission granted');
                        localStorage.setItem('locationPermission', 'granted');
                        resolve(true);
                    },
                    (error) => {
                        console.log('Location permission denied:', error.message);
                        localStorage.setItem('locationPermission', 'denied');
                        resolve(false);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }

        // Function to request notification permission
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('This browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                console.log('Notification permission already granted');
                return true;
            }

            if (Notification.permission === 'denied') {
                console.log('Notification permission denied');
                return false;
            }

            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    localStorage.setItem('notificationPermission', 'granted');
                    return true;
                } else {
                    console.log('Notification permission denied');
                    localStorage.setItem('notificationPermission', 'denied');
                    return false;
                }
            } catch (error) {
                console.log('Error requesting notification permission:', error);
                return false;
            }
        }

        // Function to show permission request modal
        function showPermissionModal() {
            // Check if we've already asked for permissions
            const locationAsked = localStorage.getItem('locationPermissionAsked');
            const notificationAsked = localStorage.getItem('notificationPermissionAsked');
            
            if (locationAsked && notificationAsked) {
                return; // Already asked, don't show again
            }

            // Create modal HTML
            const modalHTML = `
                <div id="permission-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-brand-red rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="map-pin" class="h-8 w-8 text-white"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Better Experience</h3>
                            <p class="text-gray-600 text-sm">
                                Allow location access for accurate delivery estimates and notifications for order updates.
                            </p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center gap-3 text-sm">
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="map-pin" class="h-4 w-4 text-green-600"></i>
                                </div>
                                <span class="text-gray-700">Get accurate delivery time estimates</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="bell" class="h-4 w-4 text-blue-600"></i>
                                </div>
                                <span class="text-gray-700">Receive order status updates</span>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button id="permission-deny" class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                Maybe Later
                            </button>
                            <button id="permission-allow" class="flex-1 py-3 px-4 bg-brand-red text-white rounded-lg font-medium hover:bg-opacity-90 transition-colors">
                                Allow
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();

            // Add event listeners
            document.getElementById('permission-allow').addEventListener('click', async () => {
                localStorage.setItem('locationPermissionAsked', 'true');
                localStorage.setItem('notificationPermissionAsked', 'true');
                
                // Request both permissions
                await Promise.all([
                    requestLocationPermission(),
                    requestNotificationPermission()
                ]);
                
                document.getElementById('permission-modal').remove();
            });

            document.getElementById('permission-deny').addEventListener('click', () => {
                localStorage.setItem('locationPermissionAsked', 'true');
                localStorage.setItem('notificationPermissionAsked', 'true');
                document.getElementById('permission-modal').remove();
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase Client Setup
            const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Initialize lucide icons
            lucide.createIcons();

            // Show permission modal after a short delay
            setTimeout(() => {
                showPermissionModal();
            }, 1000);

            let menuData = [];
            let cart = [];
            
            const menuGrid = document.getElementById('menu-grid');
            const categoryFilters = document.getElementById('category-filters');
            
            // Load reorder cart items from localStorage if available
            function loadReorderCart() {
                try {
                    const reorderCart = localStorage.getItem('reorderCart');
                    const reorderOrderId = localStorage.getItem('reorderOrderId');
                    
                    if (reorderCart && reorderOrderId) {
                        const reorderItems = JSON.parse(reorderCart);
                        
                        // Add reorder items to cart
                        reorderItems.forEach(item => {
                            const existingItem = cart.find(i => i.cartId === item.cartId);
                            if (existingItem) {
                                existingItem.quantity += item.quantity;
                            } else {
                                cart.push(item);
                            }
                        });
                        
                        // Clear reorder data from localStorage
                        localStorage.removeItem('reorderCart');
                        localStorage.removeItem('reorderOrderId');
                        
                        // Update cart UI
                        updateCart();
                        
                        // Show success message
                        setTimeout(() => {
                            alert(`Successfully added ${reorderItems.length} items from Order #${reorderOrderId} to your cart!`);
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error loading reorder cart:', error);
                    // Clear invalid reorder data
                    localStorage.removeItem('reorderCart');
                    localStorage.removeItem('reorderOrderId');
                }
            }
            
            async function fetchAndRenderMenu() {
                try {
                    const { data, error } = await supabaseClient
                        .from('menu_items')
                        .select(`
                            id,
                            name,
                            category,
                            prices,
                            image_url,
                            description
                        `)
                        .order('id');

                    if (error) throw error;

                    // Transform the data to match the expected structure
                    menuData = data.map(item => ({
                        id: item.id,
                        name: item.name,
                        category: item.category,
                        description: item.description || '',
                        image: item.image_url || 'https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Available',
                        options: Object.entries(item.prices || {}).map(([name, price]) => ({
                            name: name,
                            price: price
                        }))
                    }));
                    
                    renderCategories();
                    renderMenu();

                } catch (err) {
                    console.error("Error fetching menu data:", err);
                    menuGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to load menu. Please try again later.</p>`;
                }
            }
            
            function renderMenuByCategory() {
                menuGrid.innerHTML = '';
                
                if (menuData.length === 0) {
                    menuGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Loading menu...</p>`;
                    return;
                }

                // Define the desired category order
                const desiredOrder = ['Tandoori items', 'Fried Items', 'Meals', 'Breads'];
                
                // Group items by category
                const groupedItems = {};
                menuData.forEach(item => {
                    if (!groupedItems[item.category]) {
                        groupedItems[item.category] = [];
                    }
                    groupedItems[item.category].push(item);
                });
                
                // Sort categories according to desired order, then add any remaining categories
                const sortedCategories = desiredOrder.filter(cat => groupedItems[cat]);
                const remainingCategories = Object.keys(groupedItems).filter(cat => !desiredOrder.includes(cat));
                const categories = [...sortedCategories, ...remainingCategories];
                
                // Render each category section
                categories.forEach(category => {
                    // Create category section header
                    const categorySection = document.createElement('div');
                    categorySection.className = 'col-span-full mb-8';
                    categorySection.innerHTML = `
                        <div class="text-center mb-8">
                            <h3 class="text-2xl md:text-3xl font-bold text-brand-dark mb-4">${category}</h3>
                            <div class="w-24 h-1 bg-brand-red mx-auto rounded-full"></div>
                        </div>
                    `;
                    menuGrid.appendChild(categorySection);
                    
                    // Create grid container for this category's items
                    const categoryGrid = document.createElement('div');
                    categoryGrid.className = 'col-span-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8 mb-12';
                    
                    // Add items for this category
                    groupedItems[category].forEach(item => {
                        const optionsHtml = item.options.map((option, index) => `
                            <label for="option-${item.id}-${index}" class="flex items-center space-x-2 text-sm">
                                <input type="radio" id="option-${item.id}-${index}" name="option-${item.id}" value="${index}" ${index === 0 ? 'checked' : ''} data-price="${option.price}" class="form-radio text-brand-red focus:ring-brand-red">
                                <span>${option.name}</span>
                            </label>
                        `).join('');

                        const menuCard = document.createElement('div');
                        menuCard.className = 'bg-brand-light-cream rounded-xl overflow-hidden shadow-lg transition-all duration-300 menu-card-hover flex flex-col';
                        menuCard.innerHTML = `
                            <div class="relative">
                                <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
                            </div>
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold mb-1">${item.name}</h3>
                                <p class="text-sm text-gray-500 mb-4 flex-grow">${item.description}</p>
                                <div class="flex flex-wrap gap-x-4 gap-y-2 mb-4">
                                    ${optionsHtml}
                                </div>
                                <div class="flex justify-between items-center mt-auto">
                                    <span class="text-xl font-bold text-brand-red" id="price-${item.id}">₹${item.options[0].price.toFixed(2)}</span>
                const categories = ['All', ...sortedCategories, ...remainingCategories];
                
                categoryFilters.innerHTML = categories.map((category, index) => `
                    <button class="category-btn px-4 py-2 rounded-full font-medium text-sm transition-all duration-300 ${index === 0 ? 'category-btn-active' : 'bg-white text-gray-700 hover:bg-gray-100'}" data-category="${category}">
                        ${category}
                    </button>
                `).join('');
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelector('.category-btn-active').classList.remove('category-btn-active', 'bg-brand-red', 'text-white');
                        e.target.classList.add('category-btn-active', 'bg-brand-red', 'text-white');
                        renderMenu(e.target.dataset.category);
                    });
                });
            }

            function addToCart(itemId, selectedOptionIndex) {
                // The most robust way to find the item is to compare IDs as strings,
                // as data-id attributes are strings, avoiding any type mismatch issues.
                const item = menuData.find(i => String(i.id) === String(itemId));
                
                // Defensive check: Ensure the item exists in our data.
                if (!item) {
                    console.error(`Item with ID ${itemId} not found in menuData.`);
                    alert('Sorry, an error occurred and we could not add that item to your cart.');
                    return;
                }

                const selectedOption = item.options[selectedOptionIndex];

                // Defensive check: Ensure the selected option is valid.
                if (!selectedOption) {
                    console.error(`Selected option index ${selectedOptionIndex} is not valid for item ${itemId}.`);
                    alert('Sorry, an error occurred with the selected option. Please try again.');
                    return;
                }

                const cartItemId = `${itemId}-${selectedOptionIndex}`;
                const existingItem = cart.find(i => i.cartId === cartItemId);

                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({
                        cartId: cartItemId,
                        id: item.id,
                        name: item.name,
                        option: selectedOption.name,
                        price: selectedOption.price,
                        quantity: 1,
                        image: item.image,
                    });
                }

                // Meta Pixel AddToCart Event
                fbq('track', 'AddToCart', {
                    content_ids: [cartItemId],
                    content_name: `${item.name} - ${selectedOption.name}`,
                    content_type: 'product',
                    value: selectedOption.price,
                    currency: 'INR'
                });

                updateCart();
            }

            function updateCart() {
                const cartItemsContainer = document.getElementById('cart-items');
                const cartCount = document.getElementById('cart-count');
                
                cartCount.textContent = cart.reduce((total, item) => total + item.quantity, 0);
                
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = `
                        <div id="empty-cart-message" class="text-center text-gray-500 mt-8">
                            <i data-lucide="shopping-basket" class="h-16 w-16 mx-auto text-gray-300 mb-4"></i>
                            Your cart is empty. <br> Add some delicious food to get started!
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    cartItemsContainer.innerHTML = cart.map(item => `
                        <div class="flex items-center gap-4 mb-4 p-2 rounded-lg bg-white cart-item-enter-active">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                            <div class="flex-grow">
                                <p class="font-bold text-sm">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.option}</p>
                                <p class="font-semibold text-brand-red text-sm">₹${item.price.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="quantity-change p-1 rounded-full bg-gray-200 hover:bg-gray-300" data-cartid="${item.cartId}" data-change="-1">-</button>
                                <span class="font-bold w-6 text-center">${item.quantity}</span>
                                <button class="quantity-change p-1 rounded-full bg-gray-200 hover:bg-gray-300" data-cartid="${item.cartId}" data-change="1">+</button>
                            </div>
                             <button class="remove-from-cart text-gray-400 hover:text-red-500" data-cartid="${item.cartId}">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    `).join('');
                     lucide.createIcons();
                }
                updateCartTotals();
            }
            
            function updateCartTotals() {
                 const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                 const taxableValue = total / 1.05;
                 const gstAmount = total - taxableValue;

                 document.getElementById('cart-subtotal').textContent = `₹${taxableValue.toFixed(2)}`;
                 document.getElementById('cart-taxes').textContent = `₹${gstAmount.toFixed(2)}`;
                 document.getElementById('cart-total').textContent = `₹${total.toFixed(2)}`;
            }

            // Professional solution for add to cart functionality using event delegation.
            // This is more robust and avoids issues with listeners on dynamically created elements.
            document.getElementById('menu-grid').addEventListener('click', e => {
                const button = e.target.closest('.add-to-cart-btn');
                if (!button) return;

                e.preventDefault();
                e.stopPropagation();
                
                const itemId = button.dataset.id; // Keep as string for consistent comparison
                const menuCard = button.closest('.menu-card-hover');
                
                if (!menuCard) {
                    console.error('Menu card not found for item:', itemId);
                    return;
                }
                
                const radioButtons = menuCard.querySelectorAll(`input[name="option-${itemId}"]`);
                let selectedRadio = Array.from(radioButtons).find(r => r.checked);
                
                if (!selectedRadio && radioButtons.length > 0) {
                    selectedRadio = radioButtons[0];
                    selectedRadio.checked = true;
                }
                
                if (!selectedRadio) {
                    console.error('No option selected or available for item:', itemId);
                    return;
                }
                
                const selectedOptionIndex = parseInt(selectedRadio.value);
                addToCart(itemId, selectedOptionIndex);
                
                // Professional visual feedback
                const originalText = button.textContent;
                button.textContent = '✓ Added';
                button.classList.add('bg-green-600');
                button.classList.remove('bg-brand-dark');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-brand-dark');
                }, 1500);
            });
            
            // Event delegation for cart actions (quantity change, remove)
            document.getElementById('cart-items').addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;

                const cartId = target.dataset.cartid;
                
                if (target.classList.contains('quantity-change')) {
                    const change = parseInt(target.dataset.change);
                    const item = cart.find(i => i.cartId === cartId);
                    if (item) {
                        item.quantity += change;
                        if (item.quantity <= 0) {
                            cart = cart.filter(i => i.cartId !== cartId);
                        }
                    }
                } else if (target.classList.contains('remove-from-cart')) {
                    cart = cart.filter(i => i.cartId !== cartId);
                }
                updateCart();
            });

            // Mobile Menu Handlers
            const mobileMenuBtn = document.getElementById('mobile-menu-button');
            const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            
            const openMobileMenu = () => {
                mobileMenu.classList.remove('translate-x-full');
                mobileMenuOverlay.classList.remove('hidden');
            };
            const closeMobileMenu = () => {
                mobileMenu.classList.add('translate-x-full');
                mobileMenuOverlay.classList.add('hidden');
            };

            mobileMenuBtn.addEventListener('click', openMobileMenu);
            closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
            mobileMenuOverlay.addEventListener('click', closeMobileMenu);
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', closeMobileMenu);
            });

            // Cart Sidebar Handlers
            const cartBtn = document.getElementById('cart-button');
            const closeCartBtn = document.getElementById('close-cart');
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartOverlay = document.getElementById('cart-overlay');
            const checkoutBtn = document.getElementById('checkout-button');
            
            const openCart = () => {
                cartSidebar.classList.remove('translate-x-full');
                cartOverlay.classList.remove('hidden');
            };
            const closeCart = () => {
                cartSidebar.classList.add('translate-x-full');
                cartOverlay.classList.add('hidden');
            };

            cartBtn.addEventListener('click', openCart);
            closeCartBtn.addEventListener('click', closeCart);
            cartOverlay.addEventListener('click', closeCart);
            checkoutBtn.addEventListener('click', handleCheckout);

            async function handleCheckout() {
                const { data: { session } } = await supabaseClient.auth.getSession();

                if (!session) {
                    // Not logged in, redirect to auth page
                    window.location.href = 'auth.html';
                    return;
                }

                if (cart.length === 0) {
                    alert("Your cart is empty. Please add items before checking out.");
                    return;
                }

                // Get selected checkout options
                const orderType = document.querySelector('input[name="orderType"]:checked').value;
                const paymentMode = document.querySelector('input[name="paymentMethod"]:checked').value;
                const note = prompt("Any special instructions? (Optional)");

                const grandTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const taxableValue = grandTotal / 1.05;
                const taxes = grandTotal - taxableValue;

                // Meta Pixel InitiateCheckout Event
                fbq('track', 'InitiateCheckout', {
                    contents: cart.map(item => ({ id: item.cartId, quantity: item.quantity })),
                    num_items: cart.reduce((total, item) => total + item.quantity, 0),
                    value: grandTotal.toFixed(2),
                    currency: 'INR'
                });

                checkoutBtn.disabled = true;
                checkoutBtn.innerHTML = `<div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> Processing...`;

                try {
                    // 1. First, get or create customer record - FIXED APPROACH
                    // Check if customer exists for this user - we need both id (bigint) and user_id (uuid)
                    const { data: existingCustomer, error: customerCheckError } = await supabaseClient
                        .from('customers')
                        .select('id, user_id')
                        .eq('user_id', session.user.id)
                        .single();

                    let customerUserId;

                    if (customerCheckError || !existingCustomer) {
                        // Customer doesn't exist, create one
                        const { data: newCustomer, error: createCustomerError } = await supabaseClient
                            .from('customers')
                            .insert({
                                user_id: session.user.id, // This is the UUID that matches orders.customer_id
                                email: session.user.email,
                                first_name: session.user.user_metadata?.first_name || 'Customer',
                                last_name: session.user.user_metadata?.last_name || '',
                                mobile_number: '0000000000', // Required field, provide default
                                building_no: 'N/A', // Required field, provide default
                                area: 'N/A', // Required field, provide default
                                city: 'N/A', // Required field, provide default
                                state: 'N/A', // Required field, provide default
                                pin_code: '000000', // Required field, provide default
                                landmark: '',
                                password_hash: 'auto_created_during_order'
                            })
                            .select()
                            .single();

                        if (createCustomerError) {
                            console.error('Customer creation error:', createCustomerError);
                            throw new Error(`Failed to create customer: ${createCustomerError.message}`);
                        }
                        customerUserId = newCustomer.user_id; // Use the UUID user_id, not the bigint id
                    } else {
                        customerUserId = existingCustomer.user_id; // Use the UUID user_id, not the bigint id
                    }

                    console.log('Using customer user_id (UUID):', customerUserId, 'Type:', typeof customerUserId);

                    // 2. Insert the main order with proper customer_id (UUID)
                    const { data: orderData, error: orderError } = await supabaseClient
                        .from('orders')
                        .insert({
                            customer_id: customerUserId, // This should be UUID from customers.user_id
                            grand_total: grandTotal.toFixed(2),
                            payment_mode: paymentMode,
                            order_type: orderType,
                            status: 'Pending',
                            note: note,
                        })
                        .select()
                        .single();

                    if (orderError) {
                        console.error('Order insertion error:', orderError);
                        throw new Error(`Failed to create order: ${orderError.message}`);
                    }

                    // 3. Prepare order items
                    const orderItems = cart.map(item => ({
                        order_id: orderData.id,
                        item_name: item.name,
                        variant: item.option,
                        quantity: item.quantity,
                        price_per_unit: item.price.toFixed(2),
                    }));

                    // 4. Insert order items
                    const { error: itemsError } = await supabaseClient
                        .from('order_items')
                        .insert(orderItems);

                    if (itemsError) {
                        console.error('Order items insertion error:', itemsError);
                        throw new Error(`Failed to add order items: ${itemsError.message}`);
                    }

                    // 5. Success & Redirect
                    
                    // Meta Pixel Purchase Event
                    // This is the most important event for tracking conversions.
                    fbq('track', 'Purchase', {
                        value: grandTotal.toFixed(2),
                        currency: 'INR',
                        content_ids: cart.map(item => item.cartId),
                        content_type: 'product',
                        num_items: cart.reduce((total, item) => total + item.quantity, 0),
                        order_id: orderData.id // Sending order_id is crucial for CAPI deduplication
                    });
                    
                    // For maximum reliability, it's highly recommended to also send this 'Purchase' event
                    // from your server using the Meta Conversions API (CAPI). This ensures tracking
                    // even if the user has ad-blockers or browser issues.

                    window.location.href = `order-status.html?order_id=${orderData.id}`;
                    
                    cart = []; // Clear the cart
                    updateCart();
                    closeCart();

                } catch (error) {
                    console.error('Checkout Error Details:', error);
                    alert(`Error placing order: ${error.message}`);
                } finally {
                    checkoutBtn.disabled = false;
                    checkoutBtn.innerHTML = `
                        <i data-lucide="lock" class="h-5 w-5"></i>
                        Proceed to Checkout
                    `;
                    lucide.createIcons();
                }
            }
            
            // Session Management
            const authContainer = document.getElementById('auth-container');

            async function setupAuthUI() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    // User is logged in - get profile data to display name
                    const { data: profile, error } = await supabaseClient
                        .from('profiles')
                        .select('first_name, last_name')
                        .eq('id', session.user.id)
                        .single();

                    let displayName = session.user.email;
                    if (profile && profile.first_name) {
                        displayName = `${profile.first_name} ${profile.last_name || ''}`.trim();
                    } else if (session.user.user_metadata && session.user.user_metadata.first_name) {
                        displayName = `${session.user.user_metadata.first_name} ${session.user.user_metadata.last_name || ''}`.trim();
                    }

                    authContainer.innerHTML = `
                        <div class="flex items-center gap-3">
                            <a href="profile.html" class="flex items-center gap-2 text-sm font-medium hover:text-brand-red transition-colors group">
                                <div class="w-8 h-8 bg-brand-red rounded-full flex items-center justify-center text-white text-xs font-bold group-hover:scale-110 transition-transform">
                                    ${displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                                </div>
                                <span class="hidden sm:inline">Hi, ${displayName.split(' ')[0]}</span>
                            </a>
                            <button id="signout-button" class="bg-brand-red text-white text-sm font-bold py-2 px-3 rounded-full hover:bg-opacity-90 transition-all">
                                Sign Out
                            </button>
                        </div>
                    `;
                    document.getElementById('signout-button').addEventListener('click', async () => {
                        await supabaseClient.auth.signOut();
                        window.location.reload();
                    });
                } else {
                    // User is not logged in
                    authContainer.innerHTML = `
                        <a href="auth.html" class="bg-brand-red text-white text-sm font-bold py-2 px-4 rounded-full hover:bg-opacity-90 transition-all">
                            Sign In
                        </a>
                    `;
                }
            }


            // Initial Render - Await rendering before setting up auth to prevent race conditions
            await fetchAndRenderMenu();
            loadReorderCart(); // Load any reorder items from localStorage
            updateCart();
            await setupAuthUI();

            // --- Customer Coupon Logic ---
            const customerCouponInput = document.getElementById('customer-coupon-code');
            const applyCustomerCouponBtn = document.getElementById('apply-customer-coupon');
            const customerCouponMessage = document.getElementById('customer-coupon-message');
            const appliedCustomerCouponDiv = document.getElementById('applied-customer-coupon');
            const appliedCustomerCouponName = document.getElementById('applied-customer-coupon-name');
            const appliedCustomerCouponDiscount = document.getElementById('applied-customer-coupon-discount');
            const removeCustomerCouponBtn = document.getElementById('remove-customer-coupon');

            let customerAppliedCoupon = null;

            applyCustomerCouponBtn.addEventListener('click', handleApplyCustomerCoupon);
            removeCustomerCouponBtn.addEventListener('click', handleRemoveCustomerCoupon);

            async function handleApplyCustomerCoupon() {
                const code = customerCouponInput.value.trim().toUpperCase();
                if (!code) {
                    showCustomerCouponMessage('Please enter a coupon code.', 'error');
                    return;
                }

                try {
                    const { data: coupon, error } = await supabaseClient
                        .from('discount_coupons')
                        .select('*')
                        .eq('coupon_code', code)
                        .single();

                    if (error || !coupon) {
                        showCustomerCouponMessage('Invalid or expired coupon code.', 'error');
                        return;
                    }

                    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    const validationError = validateCoupon(coupon, subtotal);

                    if (validationError) {
                        showCustomerCouponMessage(validationError, 'error');
                        return;
                    }

                    customerAppliedCoupon = coupon;
                    updateCartTotals(); // Recalculate with coupon
                    showCustomerCouponMessage(`Coupon "${coupon.coupon_code}" applied!`, 'success');
                    updateAppliedCustomerCouponUI();

                } catch (err) {
                    console.error('Error applying coupon:', err);
                    showCustomerCouponMessage('Could not apply coupon. Please try again.', 'error');
                }
            }

            function handleRemoveCustomerCoupon() {
                customerAppliedCoupon = null;
                updateCartTotals();
                updateAppliedCustomerCouponUI();
                customerCouponInput.value = '';
                showCustomerCouponMessage('Coupon removed.', 'success');
            }

            function validateCoupon(coupon, subtotal) {
                const now = new Date();
                if (!coupon.is_active) return 'This coupon is not active.';
                if (new Date(coupon.valid_from) > now) return 'This coupon is not yet valid.';
                if (new Date(coupon.valid_until) < now) return 'This coupon has expired.';
                if (coupon.usage_limit && coupon.used_count >= coupon.usage_limit) return 'This coupon has reached its usage limit.';
                if (subtotal < coupon.minimum_order_amount) return `Minimum order of ₹${coupon.minimum_order_amount} required.`;
                return null;
            }

            function calculateCustomerDiscount(subtotal) {
                if (!customerAppliedCoupon) return 0;
                let discount = 0;
                if (customerAppliedCoupon.discount_type === 'percentage') {
                    discount = subtotal * (customerAppliedCoupon.discount_value / 100);
                    if (customerAppliedCoupon.maximum_discount_amount && discount > customerAppliedCoupon.maximum_discount_amount) {
                        discount = customerAppliedCoupon.maximum_discount_amount;
                    }
                } else {
                    discount = customerAppliedCoupon.discount_value;
                }
                return Math.min(discount, subtotal);
            }

            function showCustomerCouponMessage(message, type = 'info') {
                customerCouponMessage.textContent = message;
                customerCouponMessage.classList.remove('hidden', 'text-red-600', 'text-green-600');
                if (type === 'error') customerCouponMessage.classList.add('text-red-600');
                else if (type === 'success') customerCouponMessage.classList.add('text-green-600');
                setTimeout(() => customerCouponMessage.classList.add('hidden'), 4000);
            }

            function updateAppliedCustomerCouponUI() {
                if (customerAppliedCoupon) {
                    appliedCustomerCouponName.textContent = customerAppliedCoupon.coupon_name;
                    const discountText = customerAppliedCoupon.discount_type === 'percentage'
                        ? `${customerAppliedCoupon.discount_value}% off`
                        : `₹${customerAppliedCoupon.discount_value} off`;
                    appliedCustomerCouponDiscount.textContent = discountText;
                    appliedCustomerCouponDiv.classList.remove('hidden');
                } else {
                    appliedCustomerCouponDiv.classList.add('hidden');
                }
            }

            // Override updateCartTotals to include discount
            const originalUpdateCartTotals = updateCartTotals;
            updateCartTotals = function() {
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const discount = calculateCustomerDiscount(subtotal);

                const discountRow = document.getElementById('cart-discount-row');
                const discountAmountEl = document.getElementById('cart-discount-amount');
                if (discount > 0) {
                    discountRow.classList.remove('hidden');
                    discountAmountEl.textContent = `-₹${discount.toFixed(2)}`;
                } else {
                    discountRow.classList.add('hidden');
                }

                const totalAfterDiscount = subtotal - discount;
                const taxableValue = totalAfterDiscount / 1.05;
                const gstAmount = totalAfterDiscount - taxableValue;

                document.getElementById('cart-subtotal').textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById('cart-taxes').textContent = `₹${gstAmount.toFixed(2)}`;
                document.getElementById('cart-total').textContent = `₹${totalAfterDiscount.toFixed(2)}`;
            }

            // Initialize Order Status Bar
            initializeOrderStatusBar();
        });

        // Order Status Bar Management
        function initializeOrderStatusBar() {
            const bar = document.getElementById('order-status-bar');
            const orderIdElement = document.getElementById('bar-order-id');
            const orderStatusElement = document.getElementById('bar-order-status');
            const orderTimeElement = document.getElementById('bar-order-time');
            const viewButton = document.getElementById('view-order-details');
            
            let currentOrderId = null;
            let realtimeSubscription = null;

            function showOrderStatusNotification(orderId, status) {
                if (document.hidden && Notification.permission === 'granted') {
                    const notification = new Notification('Delhi Chicken Brothers', {
                        body: `Order #${orderId} is now ${status}.`,
                        icon: 'https://dcbchicken.com/images/logo.png'
                    });
                }
            }
            
            // Set up click handler
            viewButton.addEventListener('click', () => {
                if (currentOrderId) {
                    window.location.href = `order-status.html?order_id=${currentOrderId}`;
                }
            });

            // Check for active orders on page load
            checkActiveOrders();

            async function checkActiveOrders() {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) return;

                    console.log('Checking active orders for user:', session.user.id);

                    // Get customer record first
                    const { data: customer, error: customerError } = await supabaseClient
                        .from('customers')
                        .select('user_id')
                        .eq('user_id', session.user.id)
                        .single();

                    if (customerError || !customer) {
                        console.log('No customer record found for user:', session.user.id);
                        hideBar();
                        return;
                    }

                    console.log('Customer found:', customer);

                    // Check for active orders (not delivered or cancelled)
                    // Since status is an enum, we need to check what values exist
                    const { data: orders, error } = await supabaseClient
                        .from('orders')
                        .select('id, status, created_at')
                        .eq('customer_id', customer.user_id)
                        .not('status', 'in', '("Delivered", "Cancelled", "Declined")')
                        .order('created_at', { ascending: false })
                        .limit(1);

                    console.log('Orders query result:', orders, 'Error:', error);

                    if (error) {
                        console.error('Error fetching orders:', error);
                        hideBar();
                        return;
                    }

                    if (!orders || orders.length === 0) {
                        console.log('No active orders found');
                        hideBar();
                        return;
                    }

                    const activeOrder = orders[0];
                    console.log('Active order found:', activeOrder);
                    showOrder(activeOrder);
                    setupRealtimeUpdates(activeOrder.id);

                } catch (error) {
                    console.error('Error checking active orders:', error);
                }
            }

            function showOrder(order) {
                currentOrderId = order.id;
                orderIdElement.textContent = order.id;
                orderStatusElement.textContent = order.status;
                orderTimeElement.textContent = formatTimeAgo(order.created_at);
                
                // Show the bar with animation
                bar.classList.remove('translate-y-full', 'hidden');
                bar.classList.add('translate-y-0');
                
                // Reinitialize icons
                lucide.createIcons();
            }

            function hideBar() {
                bar.classList.remove('translate-y-0');
                bar.classList.add('translate-y-full');
                
                // Hide after animation completes
                setTimeout(() => {
                    bar.classList.add('hidden');
                }, 300);
                
                if (realtimeSubscription) {
                    realtimeSubscription.unsubscribe();
                }
            }

            function setupRealtimeUpdates(orderId) {
                if (realtimeSubscription) {
                    realtimeSubscription.unsubscribe();
                }

                realtimeSubscription = supabaseClient
                    .channel(`order-bar-${orderId}`)
                    .on('postgres_changes', 
                        { 
                            event: 'UPDATE', 
                            schema: 'public', 
                            table: 'orders',
                            filter: `id=eq.${orderId}`
                        },
                        (payload) => {
                            const newStatus = payload.new.status;
                            orderStatusElement.textContent = newStatus;
                            orderTimeElement.textContent = 'Just updated';

                            showOrderStatusNotification(orderId, newStatus);
                            
                            // If order is delivered or cancelled, hide the bar after a delay
                            if (['Delivered', 'Cancelled', 'Declined'].includes(newStatus)) {
                                setTimeout(() => {
                                    hideBar();
                                }, 5000); // Hide after 5 seconds
                            }
                        }
                    )
                    .subscribe();
            }

            function formatTimeAgo(timestamp) {
                const now = new Date();
                const orderTime = new Date(timestamp);
                const diffInMinutes = Math.floor((now - orderTime) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'Just now';
                if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
                
                const diffInHours = Math.floor(diffInMinutes / 60);
                if (diffInHours < 24) return `${diffInHours}h ago`;
                
                const diffInDays = Math.floor(diffInHours / 24);
                return `${diffInDays}d ago`;
            }
        }
    </script>
</body>
</html>
